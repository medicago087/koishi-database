{"version":3,"sources":["webpack://koishi-plugin-cache-aragami/./src/config.ts","webpack://koishi-plugin-cache-aragami/./src/index.ts","webpack://koishi-plugin-cache-aragami/external commonjs \"aragami\"","webpack://koishi-plugin-cache-aragami/external commonjs \"koishi\"","webpack://koishi-plugin-cache-aragami/external commonjs \"koishi-thirdeye\"","webpack://koishi-plugin-cache-aragami/webpack/bootstrap","webpack://koishi-plugin-cache-aragami/webpack/startup"],"names":["AragamiRedisConfig","AragamiConfig","config","obj","AragamiPlugin","ctx","_config","cmd","fields","info","argv","id","lockFields","field","session","o","module","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","__webpack_exports__"],"mappings":"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","file":"index.js","sourcesContent":["// import 'source-map-support/register';\nimport { SchemaProperty, RegisterSchema } from 'koishi-thirdeye';\nimport { AragamiOptions, RedisDriverOptions } from 'aragami';\n\n@RegisterSchema()\nexport class AragamiRedisConfig implements RedisDriverOptions {\n  @SchemaProperty({ description: 'Redis URI. ' })\n  uri?: string;\n}\n\n@RegisterSchema()\nexport class AragamiConfig implements AragamiOptions {\n  constructor(config: AragamiConfigLike) {}\n\n  @SchemaProperty({ description: 'Redis 配置。' })\n  redis?: AragamiRedisConfig;\n\n  getConfig(): AragamiOptions {\n    const obj = { ...this };\n    if (!Object.getOwnPropertyNames(obj.redis || {}).length) {\n      delete obj.redis;\n    }\n    return obj;\n  }\n}\n\nexport type AragamiConfigLike = AragamiOptions;\n","// import 'source-map-support/register';\nimport { AragamiConfig } from './config';\nimport {\n  DefinePlugin,\n  koishiRegistrar,\n  LifecycleEvents,\n  PartialDeep,\n  PluginSchema,\n  Provide,\n} from 'koishi-thirdeye';\nimport { Channel, Command, Context, Session, User } from 'koishi';\nimport { Aragami, AragamiOptions, WrapDecoratorBuilder } from 'aragami';\nexport * from './config';\nexport * from 'aragami';\n\ndeclare module 'koishi' {\n  interface Context {\n    aragami: AragamiPlugin;\n  }\n}\n\n@PluginSchema(AragamiConfig)\n@Provide('aragami', { immediate: true })\n@DefinePlugin({ name: 'cache-aragami' })\nexport default class AragamiPlugin extends Aragami implements LifecycleEvents {\n  constructor(\n    ctx: Context,\n    _config: PartialDeep<AragamiConfig> & AragamiOptions,\n  ) {\n    super(_config.getConfig());\n  }\n\n  onDisconnect() {\n    return this.destroy();\n  }\n\n  private commandLock<C extends Command>(\n    cmd: C,\n    fields: string[],\n    info: { idFactory: (session: Session) => string; prefix: string },\n  ) {\n    return cmd.action((argv) => {\n      if (!argv.session) return argv.next();\n      const id = info.idFactory(argv.session);\n      if (!id) return argv.next();\n      const lockFields = fields.map(\n        (field) => `koishi:${info.prefix}:${id}:${field}`,\n      );\n      return this.lock(lockFields, argv.next);\n    }, true);\n  }\n\n  commandUserLock<C extends Command>(cmd: C, fields: (keyof User)[]) {\n    return this.commandLock(cmd.userFields(fields) as C, fields, {\n      idFactory: (session: Session) => session.userId,\n      prefix: 'user',\n    });\n  }\n\n  commandChannelLock<C extends Command>(cmd: C, fields: (keyof Channel)[]) {\n    return this.commandLock(cmd.channelFields(fields) as C, fields, {\n      idFactory: (session: Session) => session.channelId,\n      prefix: 'channel',\n    });\n  }\n\n  commandGuildLock<C extends Command>(cmd: C, fields: (keyof Channel)[]) {\n    return this.commandLock(cmd.channelFields(fields) as C, fields, {\n      idFactory: (session: Session) => session.guildId || session.channelId,\n      prefix: 'guild',\n    });\n  }\n}\n\nexport const { UseCache, UseLock } = new WrapDecoratorBuilder(\n  (o) => ((o.ctx || o.__ctx) as Context).aragami,\n).build();\n\nexport const CommandUserLock = koishiRegistrar.decorateCommandTransformer(\n  (ctx, cmd, ...fields: (keyof User)[]) =>\n    ctx.aragami.commandUserLock(cmd, fields),\n);\n\nexport const CommandChannelLock = koishiRegistrar.decorateCommandTransformer(\n  (ctx, cmd, ...fields: (keyof Channel)[]) =>\n    ctx.aragami.commandChannelLock(cmd, fields),\n);\n\nexport const CommandGuildLock = koishiRegistrar.decorateCommandTransformer(\n  (ctx, cmd, ...fields: (keyof Channel)[]) =>\n    ctx.aragami.commandGuildLock(cmd, fields),\n);\n\nexport const PutLockingUser = koishiRegistrar.decorateCommandPut(\n  (info, ...fields: (keyof User)[]) => info.argv.session.user,\n  (info, ...fields) => info.ctx.aragami.commandUserLock(info.command, fields),\n);\n\nexport const PutLockingChannel = koishiRegistrar.decorateCommandPut(\n  (info, ...fields: (keyof Channel)[]) => info.argv.session.channel,\n  (info, ...fields) =>\n    info.ctx.aragami.commandChannelLock(info.command, fields),\n);\n\nexport const PutLockingGuild = koishiRegistrar.decorateCommandPut(\n  (info, ...fields: (keyof Channel)[]) => info.argv.session.guild,\n  (info, ...fields) => info.ctx.aragami.commandGuildLock(info.command, fields),\n);\n","module.exports = require(\"aragami\");","module.exports = require(\"koishi\");","module.exports = require(\"koishi-thirdeye\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(607);\n"],"sourceRoot":""}