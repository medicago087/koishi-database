var M=Object.create;var h=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var O=Object.getPrototypeOf,P=Object.prototype.hasOwnProperty;var N=(s,e)=>{for(var t in e)h(s,t,{get:e[t],enumerable:!0})},A=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of C(e))!P.call(s,r)&&r!==t&&h(s,r,{get:()=>e[r],enumerable:!(n=U(e,r))||n.enumerable});return s};var d=(s,e,t)=>(t=s!=null?M(O(s)):{},A(e||!s||!s.__esModule?h(t,"default",{value:s,enumerable:!0}):t,s)),K=s=>A(h({},"__esModule",{value:!0}),s);var $={};N($,{ChatGPTAPI:()=>m,markdownToText:()=>k});module.exports=K($);var E=require("eventsource-parser"),v=d(require("expiry-map")),f=d(require("node-fetch")),u=require("uuid");var S=d(require("remark")),b=d(require("strip-markdown"));function k(s){return(0,S.default)().use(b.default).processSync(s??"").toString()}var x="accessToken",R="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36",m=class{constructor(e){this._accessTokenCache=new v.default(10*1e3);let{sessionToken:t,markdown:n=!0,apiBaseUrl:r="https://chat.openai.com/api",backendApiBaseUrl:a="https://chat.openai.com/backend-api",userAgent:i=R}=e;if(this._sessionToken=t,this._markdown=!!n,this._apiBaseUrl=r,this._backendApiBaseUrl=a,this._userAgent=i,!this._sessionToken)throw new Error("ChatGPT invalid session token")}async getIsAuthenticated(){try{return await this.refreshAccessToken(),!0}catch{return!1}}async ensureAuth(){return await this.refreshAccessToken()}async sendMessage(e,t={}){let{converstationId:n=(0,u.v4)(),onProgress:r}=t,a=await this.refreshAccessToken(),i={action:"next",messages:[{id:(0,u.v4)(),role:"user",content:{content_type:"text",parts:[e]}}],model:"text-davinci-002-render",parent_message_id:n},o=`${this._backendApiBaseUrl}/conversation`,l="";return new Promise((B,_)=>{this._fetchSSE(o,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json","user-agent":this._userAgent},body:JSON.stringify(i),onMessage:T=>{var y,w;if(T==="[DONE]")return B(l);try{let p=JSON.parse(T).message;if(p){let c=(w=(y=p==null?void 0:p.content)==null?void 0:y.parts)==null?void 0:w[0];c&&(this._markdown||(c=k(c)),l=c,r&&r(c))}}catch(g){console.warn("fetchSSE onMessage unexpected error",g),_(g)}}}).catch(_)})}async refreshAccessToken(){let e=this._accessTokenCache.get(x);if(e)return e;try{let t=await(0,f.default)("https://chat.openai.com/api/auth/session",{headers:{cookie:`__Secure-next-auth.session-token=${this._sessionToken}`,"user-agent":this._userAgent}}).then(r=>r.json()),n=t==null?void 0:t.accessToken;if(!n)throw console.warn("no auth token",t),new Error("Unauthorized");return this._accessTokenCache.set(x,n),n}catch(t){throw new Error(`ChatGPT failed to refresh auth token: ${t.toString()}`)}}async _fetchSSE(e,t){let{onMessage:n,...r}=t,a=await(0,f.default)(e,r),i=(0,E.createParser)(o=>{o.type==="event"&&n(o.data)});a.body.on("readable",()=>{let o;for(;(o=a.body.read())!==null;)i.feed(o.toString())})}};0&&(module.exports={ChatGPTAPI,markdownToText});
//# sourceMappingURL=index.js.map