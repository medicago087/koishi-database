{"version":3,"sources":["webpack://koishi-plugin-pics/./src/config.ts","webpack://koishi-plugin-pics/./src/index.ts","webpack://koishi-plugin-pics/./src/middleware.ts","webpack://koishi-plugin-pics/./src/middlewares/assets.ts","webpack://koishi-plugin-pics/./src/middlewares/download.ts","webpack://koishi-plugin-pics/./src/picsource.ts","webpack://koishi-plugin-pics/external commonjs \"@koishijs/assets\"","webpack://koishi-plugin-pics/external commonjs \"koishi\"","webpack://koishi-plugin-pics/external commonjs \"koishi-thirdeye\"","webpack://koishi-plugin-pics/external commonjs \"lodash\"","webpack://koishi-plugin-pics/webpack/bootstrap","webpack://koishi-plugin-pics/webpack/startup"],"names":["PicsPluginConfig","config","PicSourceConfig","target","PicMiddlewareConfig","PicsContainer","source","targetCtx","processingCtx","dispose","e","disposable","mid","sourceTags","includeNonDefault","sources","s","exact","t","weightedSources","failedSource","picTags","remainingSources","result","bot","url","extraConfig","buffer","middlewares","next","nextUrl","notFound","msg","list","BasePicMiddlewarePlugin","PlainPicMiddlewarePlugin","dict","Config","ctx","PicAssetsTransformMiddleware","finalUrl","PicDownloaderMiddleware","downloadedUrl","PicSource","src","pattern","BasePicSourcePlugin","PlainPicSourcePlugin","module","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","__webpack_exports__"],"mappings":"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","file":"index.js","sourcesContent":["// import 'source-map-support/register';\nimport { SchemaProperty, RegisterSchema, SchemaClass } from 'koishi-thirdeye';\nimport { Quester, Schema } from 'koishi';\nimport { PicMiddleware, PicMiddlewareInfo, PicSourceInfo } from './def';\n\n@RegisterSchema()\nexport class PicsPluginConfig {\n  constructor(config: Partial<PicsPluginConfig>) {}\n  @SchemaProperty({ description: '指令名', default: 'pic', hidden: true })\n  commandName: string;\n\n  @SchemaProperty({\n    description: 'Assets 服务可用时，使用 Assets 缓存图片。',\n    default: true,\n  })\n  useAssets: boolean;\n\n  @SchemaProperty({ description: '使用 Base64 发送图片结果。', default: false })\n  useBase64: boolean;\n\n  @SchemaProperty({ type: Schema.object({}), default: {} })\n  httpConfig: Quester.Config;\n\n  @SchemaProperty({\n    description: 'OneBot 机器人永远使用 file 字段。',\n    default: false,\n  })\n  preferFile: boolean;\n}\n\nexport type PicsPluginConfigLike = Partial<PicsPluginConfig>;\n\n// For convenience of plugins\n\nexport class PicSourceConfig implements PicSourceInfo {\n  @SchemaProperty({ type: 'string', default: [], description: '图源标签' })\n  tags: string[];\n  @SchemaProperty({ default: 1, description: '图源权重' })\n  weight: number;\n  @SchemaProperty({ description: '图源名称', required: true })\n  name: string;\n  @SchemaProperty({ description: '图源描述' })\n  description?: string;\n  @SchemaProperty({ description: '是否为默认图源' })\n  isDefault?: boolean;\n\n  // 给目标对象注入上述对象。\n  applyTo(target: PicSourceInfo) {\n    target.tags = this.tags;\n    target.weight = this.weight;\n    target.name = this.name;\n    target.description = this.description;\n    target.isDefault = this.isDefault;\n  }\n}\n\nexport class PicMiddlewareConfig {\n  constructor(config: PicMiddlewareInfo) {}\n  @SchemaProperty({ description: '中间件名称。' })\n  name: string;\n  @SchemaProperty({ description: '是否在首位插入中间件。', default: false })\n  prepend: boolean;\n\n  applyTo(target: PicMiddleware) {\n    target.name = this.name;\n    target.prepend = this.prepend;\n  }\n}\n","// import 'source-map-support/register';\nimport { Context, Random, Logger, Bot, remove } from 'koishi';\nimport { PicsPluginConfig } from './config';\nimport _ from 'lodash';\nimport { segment, Quester } from 'koishi';\nimport {\n  StarterPlugin,\n  Caller,\n  CommandExample,\n  CommandLocale,\n  DefinePlugin,\n  Inject,\n  InjectLogger,\n  LifecycleEvents,\n  Provide,\n  PutArgs,\n  PutBot,\n  PutOption,\n  PutRenderer,\n  Renderer,\n  UseCommand,\n} from 'koishi-thirdeye';\nimport { AxiosRequestConfig } from 'axios';\nimport { PicAssetsTransformMiddleware } from './middlewares/assets';\nimport { PicDownloaderMiddleware } from './middlewares/download';\nimport { PicMiddleware, PicNext, PicResult } from './def';\nimport { PicSource } from './picsource';\nexport * from './config';\nexport * from './middleware';\nexport * from './picsource';\nexport * from './def';\n\ndeclare module 'koishi' {\n  interface Context {\n    pics: PicsContainer;\n  }\n}\n\n@Provide('pics', { immediate: true })\n@DefinePlugin({ name: 'pics' })\nexport default class PicsContainer\n  extends StarterPlugin(PicsPluginConfig)\n  implements LifecycleEvents\n{\n  private sources = new Map<PicSource, () => boolean>();\n  private picMiddlewares: PicMiddleware[] = [];\n\n  @Caller()\n  private caller: Context;\n\n  @InjectLogger()\n  private logger: Logger;\n\n  @Inject(true)\n  private http: Quester;\n\n  private _http: Quester;\n\n  addSource(source: PicSource, targetCtx?: Context) {\n    const processingCtx: Context = targetCtx || this.caller;\n    const dispose = processingCtx.on('dispose', () =>\n      this.removeSource(source),\n    );\n    this.sources.set(source, dispose);\n    processingCtx.on('ready', () => source.onStartup());\n    this.logger.info(`Loaded pic source ${source.name}.`);\n  }\n\n  async removeSource(source: PicSource) {\n    try {\n      await source.onShutdown();\n    } catch (e) {\n      this.logger.warn(`Shutdown of ${source.name} failed: ${e.toString()}`);\n    }\n    const disposable = this.sources.get(source);\n    this.sources.delete(source);\n    if (disposable) {\n      disposable();\n    }\n    this.logger.info(`Removed pic source ${source.name}.`);\n  }\n\n  private allSources() {\n    return Array.from(this.sources.keys());\n  }\n\n  middleware(mid: PicMiddleware, targetCtx?: Context) {\n    const processingCtx: Context = targetCtx || this.caller;\n    mid.name ||= processingCtx.state?.runtime?.plugin?.name;\n    const disposable = processingCtx.on('dispose', () => {\n      disposable();\n      this.removeMiddlware(mid);\n    });\n    if (mid.prepend) {\n      this.picMiddlewares.unshift(mid);\n    } else {\n      this.picMiddlewares.push(mid);\n    }\n  }\n\n  removeMiddlware(mid: PicMiddleware) {\n    remove(this.picMiddlewares, mid);\n  }\n\n  pickAvailableSources(sourceTags: string[] = [], includeNonDefault = false) {\n    let sources = this.allSources();\n    if (sourceTags.length) {\n      sources = sources.filter(\n        (s) =>\n          sourceTags.some((exact) => s.name === exact) ||\n          sourceTags.every((t) => s.tags.includes(t)),\n      );\n    } else if (!includeNonDefault && sources.length > 1) {\n      sources = sources.filter((s) => s.isDefault);\n    }\n    return sources;\n  }\n\n  randomSourceWithWeight(sources: PicSource[] = this.allSources()) {\n    if (!sources.length) {\n      return null;\n    }\n    if (sources.length === 1) {\n      return sources[0];\n    }\n    const weightedSources = _.flatten(\n      sources.map((s) => _.range(s.weight).map(() => s)),\n    );\n    return Random.pick(weightedSources);\n  }\n\n  private async retryWithAnotherSource(\n    failedSource: PicSource,\n    sources: PicSource[],\n    picTags: string[],\n  ) {\n    const remainingSources = sources.filter((s) => s !== failedSource);\n    return this.fetchPicsWithSources(remainingSources, picTags);\n  }\n\n  private async fetchPicsWithSources(\n    sources: PicSource[],\n    picTags: string[],\n  ): Promise<PicResult> {\n    const source = this.randomSourceWithWeight(sources);\n    if (!source) {\n      return null;\n    }\n    this.logger.debug(\n      `Using source ${source.name} for searching ${picTags.join(',')}`,\n    );\n    try {\n      const result = await source.randomPic(picTags);\n      if (!result) {\n        this.logger.debug(\n          `Pic not found from ${source.name}, retrying with another source.`,\n        );\n        return this.retryWithAnotherSource(source, sources, picTags);\n      }\n      this.logger.debug(`Got pic ${result.url}`);\n      return result;\n    } catch (e) {\n      this.logger.warn(\n        `Fetch pic failed from ${\n          source.name\n        }, retrying with another source: ${e.toString()}`,\n      );\n      return this.retryWithAnotherSource(source, sources, picTags);\n    }\n  }\n\n  async randomPic(picTags: string[] = [], sourceTags: string[] = []) {\n    const sources = this.pickAvailableSources(sourceTags);\n    return this.fetchPicsWithSources(sources, picTags);\n  }\n\n  isOneBotBot(bot?: Bot) {\n    return (\n      bot &&\n      (bot.platform === 'onebot' ||\n        (bot.platform === 'qqguild' && bot['parentBot']?.platform === 'onebot'))\n    );\n  }\n\n  async urlToBuffer(\n    url: string,\n    extraConfig: AxiosRequestConfig = {},\n  ): Promise<Buffer> {\n    if (url.startsWith('base64://')) {\n      return Buffer.from(url.slice(9), 'base64');\n    }\n    const data = await this._http.get<Buffer>(url, {\n      responseType: 'arraybuffer',\n      ...extraConfig,\n    });\n    return data as Buffer;\n  }\n\n  bufferToUrl(buffer: Buffer) {\n    return `base64://${buffer.toString('base64')}`;\n  }\n\n  async download(url: string, extraConfig: AxiosRequestConfig = {}) {\n    if (url.startsWith('base64://')) {\n      return url;\n    }\n    const buffer = await this.urlToBuffer(url, extraConfig);\n    return this.bufferToUrl(buffer);\n  }\n\n  async resolveUrl(url: string, middlewares = this.picMiddlewares) {\n    if (!middlewares.length) {\n      return url;\n    }\n    const next: PicNext = async (nextUrl) => {\n      nextUrl ||= url;\n      const nextResult = await this.resolveUrl(nextUrl, middlewares.slice(1));\n      return nextResult || nextUrl;\n    };\n    try {\n      let result = await middlewares[0].use(url, next);\n      if (!result) {\n        this.logger.warn(\n          `Got empty result from middleware ${middlewares[0].name || '???'}`,\n        );\n        result = url;\n      }\n      return result;\n    } catch (e) {\n      this.logger.warn(`Resolve url ${url} failed: ${e.toString()}`);\n      return url;\n    }\n  }\n\n  async getSegment(url: string) {\n    url = await this.resolveUrl(url);\n    return segment.image(url);\n  }\n\n  private installDefaultMiddlewares() {\n    if (this.config.useAssets) {\n      this.ctx.plugin(PicAssetsTransformMiddleware);\n    }\n    if (this.config.useBase64) {\n      this.ctx.plugin(PicDownloaderMiddleware);\n    }\n  }\n\n  @UseCommand('{{commandName}} [...tags:string]')\n  @CommandLocale('zh', {\n    description: '获取随机图片',\n    options: {\n      source: `指定图源，逗号分隔。图源可以用 {{commandName}}.sources 查询。`,\n    },\n    usage: `从各个图源中随机获取一张随机图片。图源可以用 {{commandName}}.sources 查询。参数均为可选。`,\n    messages: {\n      'not-found': '未找到任何图片。',\n    },\n  })\n  @CommandLocale('en', {\n    description: 'Get random picture',\n    options: {\n      source: `Specify the source, separated by comma. You can query the sources with {{commandName}}.sources.`,\n    },\n    usage: `Get a random picture from a random source. Sources can be queried with command {{commandName}}.sources`,\n    messages: {\n      'not-found': 'No pictures found.',\n    },\n  })\n  @CommandExample(`{{commandName}}`)\n  @CommandExample(`{{commandName}} yuyuko`)\n  @CommandExample(`{{commandName}} -s yande`)\n  @CommandExample(`{{commandName}} -s yande yuyuko saigyouji`)\n  async onPic(\n    @PutOption('source', `-s <source>`) source: string,\n    @PutArgs() picTags: string[],\n    @PutRenderer('.not-found') notFound: Renderer,\n  ) {\n    const sourceTags = source?.split(/[ ,+\\uFF0C\\uFF0B\\u3001]/) || [];\n    picTags ||= [];\n    const result = await this.randomPic(picTags, sourceTags);\n    if (!result) {\n      return notFound();\n    }\n\n    let msg = (await this.getSegment(result.url)).toString();\n    if (result.description) {\n      msg += `\\n${result.description}`;\n    }\n    return msg;\n  }\n\n  @UseCommand('{{commandName}}.sources')\n  @CommandLocale('zh', {\n    description: '查询图源列表',\n    options: {},\n    usage: '图源标签可用于图片获取的图源筛选。',\n    messages: {\n      list: '图源的列表如下:',\n    },\n  })\n  @CommandLocale('en', {\n    description: 'Query picture sources',\n    options: {},\n    usage: 'Source tags can be used to filter picture sources.',\n    messages: {\n      list: 'List of sources:',\n    },\n  })\n  @CommandExample(`{{commandName}}.sources`)\n  @CommandExample(`{{commandName}}.sources pixiv`)\n  async onQuerySource(\n    @PutArgs() sourceTags: string[],\n    @PutRenderer('.list') list: Renderer,\n  ) {\n    sourceTags ||= [];\n    const sources = this.pickAvailableSources(sourceTags, true);\n    return `${list()}\\n${sources.map((s) => s.getDisplayString()).join('\\n')}`;\n  }\n\n  onApply() {\n    this._http = this.http.extend(this.config.httpConfig);\n    this.installDefaultMiddlewares();\n  }\n}\n","import { Awaitable, Context, Logger, Schema } from 'koishi';\nimport { PicMiddlewareConfig } from './config';\nimport {\n  CreatePluginFactory,\n  Inject,\n  InjectLogger,\n  LifecycleEvents,\n  PartialDeep,\n  Reusable,\n  schemaFromClass,\n  StarterPlugin,\n} from 'koishi-thirdeye';\nimport PicsContainer, { PicMiddlewareInfo } from './index';\nimport { PicMiddleware, PicNext } from './def';\n\n@Reusable()\nexport class BasePicMiddlewarePlugin\n  extends StarterPlugin(PicMiddlewareConfig)\n  implements PicMiddleware, LifecycleEvents\n{\n  @Inject(true)\n  protected pics: PicsContainer;\n\n  @InjectLogger()\n  protected logger: Logger;\n\n  onApply() {\n    this.config.applyTo(this);\n    this.pics.middleware(this);\n  }\n\n  use(url: string, next: PicNext): Awaitable<string> {\n    return next(url);\n  }\n}\n\nexport const PicMiddlewarePlugin = CreatePluginFactory(\n  BasePicMiddlewarePlugin,\n  PicMiddlewareConfig,\n);\n\nexport function PlainPicMiddlewarePlugin<C>(dict: {\n  [K in keyof C]: Schema<C[K]>;\n}) {\n  const Config = schemaFromClass(PicMiddlewareConfig) as unknown as Schema<\n    PartialDeep<PicMiddlewareConfig & C>,\n    PicMiddlewareConfig & C\n  >;\n  Object.assign(Config.dict, dict);\n  return class PlainPicMiddlewarePluginBase implements PicMiddleware {\n    name?: string;\n    prepend?: boolean;\n    config: PicMiddlewareInfo & C;\n    static Config = Config;\n    static using = ['pics'] as const;\n    static reusable = true;\n    constructor(\n      public ctx: Context,\n      config: PartialDeep<C & PicMiddlewareInfo>,\n    ) {\n      this.config = config as PicMiddlewareInfo & C;\n      this.name = config.name;\n      this.prepend = config.prepend;\n      ctx.pics.middleware(this);\n    }\n\n    use(url: string, next: PicNext): Awaitable<string> {\n      return next(url);\n    }\n  };\n}\n","import { DefinePlugin, Inject } from 'koishi-thirdeye';\nimport Assets from '@koishijs/assets';\nimport { PicNext } from '../def';\nimport { PicMiddlewarePlugin } from '../middleware';\n\n@DefinePlugin()\nexport class PicAssetsTransformMiddleware extends PicMiddlewarePlugin() {\n  @Inject()\n  private assets: Assets;\n\n  override async use(url: string, next: PicNext) {\n    const finalUrl = await next(url);\n    if (!this.assets) {\n      return finalUrl;\n    }\n    return this.assets.upload(finalUrl, undefined);\n  }\n}\n","import { DefinePlugin } from 'koishi-thirdeye';\nimport { PicMiddlewarePlugin } from '../middleware';\nimport { PicNext } from '../def';\n\n@DefinePlugin()\nexport class PicDownloaderMiddleware extends PicMiddlewarePlugin() {\n  override async use(url: string, next: PicNext) {\n    const downloadedUrl = await this.pics.download(url);\n    return next(downloadedUrl);\n  }\n}\n","import { Context, Awaitable, Logger, Schema } from 'koishi';\nimport {\n  PartialDeep,\n  InjectConfig,\n  Inject,\n  InjectLogger,\n  CreatePluginFactory,\n  schemaFromClass,\n  Apply,\n  Reusable,\n} from 'koishi-thirdeye';\nimport PicsContainer from '.';\nimport { PicSourceConfig } from './config';\nimport { PicSourceInfo, PicResult } from './def';\n\nexport class PicSource implements PicSourceInfo {\n  constructor(public ctx: Context) {}\n  tags: string[] = [];\n  weight = 1;\n  name = 'default';\n  description = '';\n  isDefault = false;\n\n  applyConfig(src: Partial<PicSourceInfo>) {\n    this.name = src.name;\n    this.tags ??= src.tags;\n    this.weight ??= src.weight;\n    this.description ??= src.description;\n    this.isDefault ??= src.isDefault;\n  }\n\n  randomPic(picTags: string[]): Awaitable<PicResult> {\n    // For override\n    throw new Error(`Not implemented`);\n  }\n\n  onStartup(): Awaitable<void> {\n    return;\n  }\n  onShutdown(): Awaitable<void> {\n    return;\n  }\n  getDisplayString() {\n    let pattern = this.name;\n    if (this.tags.length) {\n      pattern += `\\t标签: ${this.tags.join(',')}`;\n    }\n    if (this.description) {\n      pattern += `\\t${this.description}`;\n    }\n    return pattern;\n  }\n}\n\n@Reusable()\nexport class BasePicSourcePlugin extends PicSource {\n  constructor(ctx: Context, config: PartialDeep<PicSourceConfig>) {\n    super(ctx);\n  }\n\n  @InjectConfig()\n  config: PicSourceConfig;\n\n  @Inject(true)\n  pics: PicsContainer;\n\n  @InjectLogger()\n  logger: Logger;\n\n  @Apply()\n  initializeSource() {\n    this.config.applyTo(this);\n    this.pics.addSource(this);\n  }\n}\n\nexport const PicSourcePlugin = CreatePluginFactory(\n  BasePicSourcePlugin,\n  PicSourceConfig,\n);\n\nexport function PlainPicSourcePlugin<C>(dict: {\n  [K in keyof C]: Schema<C[K]>;\n}) {\n  const Config = schemaFromClass(PicSourceConfig) as unknown as Schema<\n    PartialDeep<PicSourceConfig & C>,\n    PicSourceConfig & C\n  >;\n  Object.assign(Config.dict, dict);\n  return class PlainPicSourcePluginBase extends PicSource {\n    config: PicSourceInfo & C;\n    constructor(ctx: Context, config: PartialDeep<C & PicSourceInfo>) {\n      super(ctx);\n      this.config = config as PicSourceInfo & C;\n      this.applyConfig(config);\n      ctx.pics.addSource(this);\n    }\n    static Config = Config;\n    static using = ['pics'] as const;\n    static reusable = true;\n  };\n}\n","module.exports = require(\"@koishijs/assets\");","module.exports = require(\"koishi\");","module.exports = require(\"koishi-thirdeye\");","module.exports = require(\"lodash\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(607);\n"],"sourceRoot":""}