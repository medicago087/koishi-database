var $=Object.defineProperty;var b=(C,M)=>$(C,"name",{value:M,configurable:!0});(()=>{"use strict";var C={913:function(S,a,d){var m=this&&this.__decorate||function(u,s,l,t){var o=arguments.length,p=o<3?s:t===null?t=Object.getOwnPropertyDescriptor(s,l):t,h;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")p=Reflect.decorate(u,s,l,t);else for(var r=u.length-1;r>=0;r--)(h=u[r])&&(p=(o<3?h(p):o>3?h(s,l,p):h(s,l))||p);return o>3&&p&&Object.defineProperty(s,l,p),p},f=this&&this.__metadata||function(u,s){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(u,s)};Object.defineProperty(a,"__esModule",{value:!0}),a.PicMiddlewareConfig=a.PicSourceConfig=a.PicsPluginConfig=void 0;const v=d(856),_=d(126);let g=b(class{constructor(s){}},"PicsPluginConfig");m([(0,v.SchemaProperty)({description:"\u6307\u4EE4\u540D",default:"pic",hidden:!0}),f("design:type",String)],g.prototype,"commandName",void 0),m([(0,v.SchemaProperty)({description:"Assets \u670D\u52A1\u53EF\u7528\u65F6\uFF0C\u4F7F\u7528 Assets \u7F13\u5B58\u56FE\u7247\u3002",default:!0}),f("design:type",Boolean)],g.prototype,"useAssets",void 0),m([(0,v.SchemaProperty)({description:"\u4F7F\u7528 Base64 \u53D1\u9001\u56FE\u7247\u7ED3\u679C\u3002",default:!1}),f("design:type",Boolean)],g.prototype,"useBase64",void 0),m([(0,v.SchemaProperty)({type:_.Schema.object({}),default:{}}),f("design:type",_.Quester.Config)],g.prototype,"httpConfig",void 0),m([(0,v.SchemaProperty)({description:"OneBot \u673A\u5668\u4EBA\u6C38\u8FDC\u4F7F\u7528 file \u5B57\u6BB5\u3002",default:!1}),f("design:type",Boolean)],g.prototype,"preferFile",void 0),g=m([(0,v.RegisterSchema)(),f("design:paramtypes",[Object])],g),a.PicsPluginConfig=g;class y{applyTo(s){s.tags=this.tags,s.weight=this.weight,s.name=this.name,s.description=this.description,s.isDefault=this.isDefault}}b(y,"PicSourceConfig"),m([(0,v.SchemaProperty)({type:"string",default:[],description:"\u56FE\u6E90\u6807\u7B7E"}),f("design:type",Array)],y.prototype,"tags",void 0),m([(0,v.SchemaProperty)({default:1,description:"\u56FE\u6E90\u6743\u91CD"}),f("design:type",Number)],y.prototype,"weight",void 0),m([(0,v.SchemaProperty)({description:"\u56FE\u6E90\u540D\u79F0",required:!0}),f("design:type",String)],y.prototype,"name",void 0),m([(0,v.SchemaProperty)({description:"\u56FE\u6E90\u63CF\u8FF0"}),f("design:type",String)],y.prototype,"description",void 0),m([(0,v.SchemaProperty)({description:"\u662F\u5426\u4E3A\u9ED8\u8BA4\u56FE\u6E90"}),f("design:type",Boolean)],y.prototype,"isDefault",void 0),a.PicSourceConfig=y;class P{constructor(s){}applyTo(s){s.name=this.name,s.prepend=this.prepend}}b(P,"PicMiddlewareConfig"),m([(0,v.SchemaProperty)({description:"\u4E2D\u95F4\u4EF6\u540D\u79F0\u3002"}),f("design:type",String)],P.prototype,"name",void 0),m([(0,v.SchemaProperty)({description:"\u662F\u5426\u5728\u9996\u4F4D\u63D2\u5165\u4E2D\u95F4\u4EF6\u3002",default:!1}),f("design:type",Boolean)],P.prototype,"prepend",void 0),a.PicMiddlewareConfig=P},519:(S,a)=>{Object.defineProperty(a,"__esModule",{value:!0})},607:function(S,a,d){var m=this&&this.__createBinding||(Object.create?function(r,e,i,n){n===void 0&&(n=i);var c=Object.getOwnPropertyDescriptor(e,i);(!c||("get"in c?!e.__esModule:c.writable||c.configurable))&&(c={enumerable:!0,get:function(){return e[i]}}),Object.defineProperty(r,n,c)}:function(r,e,i,n){n===void 0&&(n=i),r[n]=e[i]}),f=this&&this.__decorate||function(r,e,i,n){var c=arguments.length,w=c<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,i):n,j;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")w=Reflect.decorate(r,e,i,n);else for(var O=r.length-1;O>=0;O--)(j=r[O])&&(w=(c<3?j(w):c>3?j(e,i,w):j(e,i))||w);return c>3&&w&&Object.defineProperty(e,i,w),w},v=this&&this.__exportStar||function(r,e){for(var i in r)i!=="default"&&!Object.prototype.hasOwnProperty.call(e,i)&&m(e,r,i)},_=this&&this.__metadata||function(r,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(r,e)},g=this&&this.__param||function(r,e){return function(i,n){e(i,n,r)}},y=this&&this.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(a,"__esModule",{value:!0});const P=d(126),u=d(913),s=y(d(517)),l=d(126),t=d(856),o=d(670),p=d(177);v(d(913),a),v(d(714),a),v(d(310),a),v(d(519),a);let h=b(class extends(0,t.StarterPlugin)(u.PicsPluginConfig){constructor(){super(...arguments),this.sources=new Map,this.picMiddlewares=[]}addSource(e,i){const n=i||this.caller,c=n.on("dispose",()=>this.removeSource(e));this.sources.set(e,c),n.on("ready",()=>e.onStartup()),this.logger.info(`Loaded pic source ${e.name}.`)}async removeSource(e){try{await e.onShutdown()}catch(n){this.logger.warn(`Shutdown of ${e.name} failed: ${n.toString()}`)}const i=this.sources.get(e);this.sources.delete(e),i&&i(),this.logger.info(`Removed pic source ${e.name}.`)}allSources(){return Array.from(this.sources.keys())}middleware(e,i){const n=i||this.caller;e.name||=n.state?.runtime?.plugin?.name;const c=n.on("dispose",()=>{c(),this.removeMiddlware(e)});e.prepend?this.picMiddlewares.unshift(e):this.picMiddlewares.push(e)}removeMiddlware(e){(0,P.remove)(this.picMiddlewares,e)}pickAvailableSources(e=[],i=!1){let n=this.allSources();return e.length?n=n.filter(c=>e.some(w=>c.name===w)||e.every(w=>c.tags.includes(w))):!i&&n.length>1&&(n=n.filter(c=>c.isDefault)),n}randomSourceWithWeight(e=this.allSources()){if(!e.length)return null;if(e.length===1)return e[0];const i=s.default.flatten(e.map(n=>s.default.range(n.weight).map(()=>n)));return P.Random.pick(i)}async retryWithAnotherSource(e,i,n){const c=i.filter(w=>w!==e);return this.fetchPicsWithSources(c,n)}async fetchPicsWithSources(e,i){const n=this.randomSourceWithWeight(e);if(!n)return null;this.logger.debug(`Using source ${n.name} for searching ${i.join(",")}`);try{const c=await n.randomPic(i);return c?(this.logger.debug(`Got pic ${c.url}`),c):(this.logger.debug(`Pic not found from ${n.name}, retrying with another source.`),this.retryWithAnotherSource(n,e,i))}catch(c){return this.logger.warn(`Fetch pic failed from ${n.name}, retrying with another source: ${c.toString()}`),this.retryWithAnotherSource(n,e,i)}}async randomPic(e=[],i=[]){const n=this.pickAvailableSources(i);return this.fetchPicsWithSources(n,e)}isOneBotBot(e){return e&&(e.platform==="onebot"||e.platform==="qqguild"&&e.parentBot?.platform==="onebot")}async urlToBuffer(e,i={}){return e.startsWith("base64://")?Buffer.from(e.slice(9),"base64"):await this._http.get(e,{responseType:"arraybuffer",...i})}bufferToUrl(e){return`base64://${e.toString("base64")}`}async download(e,i={}){if(e.startsWith("base64://"))return e;const n=await this.urlToBuffer(e,i);return this.bufferToUrl(n)}async resolveUrl(e,i=this.picMiddlewares){if(!i.length)return e;const n=b(async c=>(c||=e,await this.resolveUrl(c,i.slice(1))||c),"next");try{let c=await i[0].use(e,n);return c||(this.logger.warn(`Got empty result from middleware ${i[0].name||"???"}`),c=e),c}catch(c){return this.logger.warn(`Resolve url ${e} failed: ${c.toString()}`),e}}async getSegment(e){return e=await this.resolveUrl(e),l.segment.image(e)}installDefaultMiddlewares(){this.config.useAssets&&this.ctx.plugin(o.PicAssetsTransformMiddleware),this.config.useBase64&&this.ctx.plugin(p.PicDownloaderMiddleware)}async onPic(e,i,n){const c=e?.split(/[ ,+\uFF0C\uFF0B\u3001]/)||[];i||=[];const w=await this.randomPic(i,c);if(!w)return n();let j=(await this.getSegment(w.url)).toString();return w.description&&(j+=`
${w.description}`),j}async onQuerySource(e,i){e||=[];const n=this.pickAvailableSources(e,!0);return`${i()}
${n.map(c=>c.getDisplayString()).join(`
`)}`}onApply(){this._http=this.http.extend(this.config.httpConfig),this.installDefaultMiddlewares()}},"PicsContainer");f([(0,t.Caller)(),_("design:type",P.Context)],h.prototype,"caller",void 0),f([(0,t.InjectLogger)(),_("design:type",P.Logger)],h.prototype,"logger",void 0),f([(0,t.Inject)(!0),_("design:type",l.Quester)],h.prototype,"http",void 0),f([(0,t.UseCommand)("{{commandName}} [...tags:string]"),(0,t.CommandLocale)("zh",{description:"\u83B7\u53D6\u968F\u673A\u56FE\u7247",options:{source:"\u6307\u5B9A\u56FE\u6E90\uFF0C\u9017\u53F7\u5206\u9694\u3002\u56FE\u6E90\u53EF\u4EE5\u7528 {{commandName}}.sources \u67E5\u8BE2\u3002"},usage:"\u4ECE\u5404\u4E2A\u56FE\u6E90\u4E2D\u968F\u673A\u83B7\u53D6\u4E00\u5F20\u968F\u673A\u56FE\u7247\u3002\u56FE\u6E90\u53EF\u4EE5\u7528 {{commandName}}.sources \u67E5\u8BE2\u3002\u53C2\u6570\u5747\u4E3A\u53EF\u9009\u3002",messages:{"not-found":"\u672A\u627E\u5230\u4EFB\u4F55\u56FE\u7247\u3002"}}),(0,t.CommandLocale)("en",{description:"Get random picture",options:{source:"Specify the source, separated by comma. You can query the sources with {{commandName}}.sources."},usage:"Get a random picture from a random source. Sources can be queried with command {{commandName}}.sources",messages:{"not-found":"No pictures found."}}),(0,t.CommandExample)("{{commandName}}"),(0,t.CommandExample)("{{commandName}} yuyuko"),(0,t.CommandExample)("{{commandName}} -s yande"),(0,t.CommandExample)("{{commandName}} -s yande yuyuko saigyouji"),g(0,(0,t.PutOption)("source","-s <source>")),g(1,(0,t.PutArgs)()),g(2,(0,t.PutRenderer)(".not-found")),_("design:type",Function),_("design:paramtypes",[String,Array,Function]),_("design:returntype",Promise)],h.prototype,"onPic",null),f([(0,t.UseCommand)("{{commandName}}.sources"),(0,t.CommandLocale)("zh",{description:"\u67E5\u8BE2\u56FE\u6E90\u5217\u8868",options:{},usage:"\u56FE\u6E90\u6807\u7B7E\u53EF\u7528\u4E8E\u56FE\u7247\u83B7\u53D6\u7684\u56FE\u6E90\u7B5B\u9009\u3002",messages:{list:"\u56FE\u6E90\u7684\u5217\u8868\u5982\u4E0B:"}}),(0,t.CommandLocale)("en",{description:"Query picture sources",options:{},usage:"Source tags can be used to filter picture sources.",messages:{list:"List of sources:"}}),(0,t.CommandExample)("{{commandName}}.sources"),(0,t.CommandExample)("{{commandName}}.sources pixiv"),g(0,(0,t.PutArgs)()),g(1,(0,t.PutRenderer)(".list")),_("design:type",Function),_("design:paramtypes",[Array,Function]),_("design:returntype",Promise)],h.prototype,"onQuerySource",null),h=f([(0,t.Provide)("pics",{immediate:!0}),(0,t.DefinePlugin)({name:"pics"})],h),a.default=h},714:function(S,a,d){var m=this&&this.__decorate||function(l,t,o,p){var h=arguments.length,r=h<3?t:p===null?p=Object.getOwnPropertyDescriptor(t,o):p,e;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(l,t,o,p);else for(var i=l.length-1;i>=0;i--)(e=l[i])&&(r=(h<3?e(r):h>3?e(t,o,r):e(t,o))||r);return h>3&&r&&Object.defineProperty(t,o,r),r},f=this&&this.__metadata||function(l,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(l,t)},v=this&&this.__importDefault||function(l){return l&&l.__esModule?l:{default:l}};Object.defineProperty(a,"__esModule",{value:!0}),a.PlainPicMiddlewarePlugin=a.PicMiddlewarePlugin=a.BasePicMiddlewarePlugin=void 0;const _=d(126),g=d(913),y=d(856),P=v(d(607));let u=b(class extends(0,y.StarterPlugin)(g.PicMiddlewareConfig){onApply(){this.config.applyTo(this),this.pics.middleware(this)}use(t,o){return o(t)}},"BasePicMiddlewarePlugin");m([(0,y.Inject)(!0),f("design:type",P.default)],u.prototype,"pics",void 0),m([(0,y.InjectLogger)(),f("design:type",_.Logger)],u.prototype,"logger",void 0),u=m([(0,y.Reusable)()],u),a.BasePicMiddlewarePlugin=u,a.PicMiddlewarePlugin=(0,y.CreatePluginFactory)(u,g.PicMiddlewareConfig);function s(l){var t;const o=(0,y.schemaFromClass)(g.PicMiddlewareConfig);return Object.assign(o.dict,l),t=b(class{constructor(h,r){this.ctx=h,this.config=r,this.name=r.name,this.prepend=r.prepend,h.pics.middleware(this)}use(h,r){return r(h)}},"PlainPicMiddlewarePluginBase"),t.Config=o,t.using=["pics"],t.reusable=!0,t}b(s,"PlainPicMiddlewarePlugin"),a.PlainPicMiddlewarePlugin=s},670:function(S,a,d){var m=this&&this.__decorate||function(u,s,l,t){var o=arguments.length,p=o<3?s:t===null?t=Object.getOwnPropertyDescriptor(s,l):t,h;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")p=Reflect.decorate(u,s,l,t);else for(var r=u.length-1;r>=0;r--)(h=u[r])&&(p=(o<3?h(p):o>3?h(s,l,p):h(s,l))||p);return o>3&&p&&Object.defineProperty(s,l,p),p},f=this&&this.__metadata||function(u,s){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(u,s)},v=this&&this.__importDefault||function(u){return u&&u.__esModule?u:{default:u}};Object.defineProperty(a,"__esModule",{value:!0}),a.PicAssetsTransformMiddleware=void 0;const _=d(856),g=v(d(24)),y=d(714);let P=b(class extends(0,y.PicMiddlewarePlugin)(){async use(s,l){const t=await l(s);return this.assets?this.assets.upload(t,void 0):t}},"PicAssetsTransformMiddleware");m([(0,_.Inject)(),f("design:type",g.default)],P.prototype,"assets",void 0),P=m([(0,_.DefinePlugin)()],P),a.PicAssetsTransformMiddleware=P},177:function(S,a,d){var m=this&&this.__decorate||function(g,y,P,u){var s=arguments.length,l=s<3?y:u===null?u=Object.getOwnPropertyDescriptor(y,P):u,t;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")l=Reflect.decorate(g,y,P,u);else for(var o=g.length-1;o>=0;o--)(t=g[o])&&(l=(s<3?t(l):s>3?t(y,P,l):t(y,P))||l);return s>3&&l&&Object.defineProperty(y,P,l),l};Object.defineProperty(a,"__esModule",{value:!0}),a.PicDownloaderMiddleware=void 0;const f=d(856),v=d(714);let _=b(class extends(0,v.PicMiddlewarePlugin)(){async use(y,P){const u=await this.pics.download(y);return P(u)}},"PicDownloaderMiddleware");_=m([(0,f.DefinePlugin)()],_),a.PicDownloaderMiddleware=_},310:function(S,a,d){var m=this&&this.__decorate||function(t,o,p,h){var r=arguments.length,e=r<3?o:h===null?h=Object.getOwnPropertyDescriptor(o,p):h,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")e=Reflect.decorate(t,o,p,h);else for(var n=t.length-1;n>=0;n--)(i=t[n])&&(e=(r<3?i(e):r>3?i(o,p,e):i(o,p))||e);return r>3&&e&&Object.defineProperty(o,p,e),e},f=this&&this.__metadata||function(t,o){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(t,o)},v=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(a,"__esModule",{value:!0}),a.PlainPicSourcePlugin=a.PicSourcePlugin=a.BasePicSourcePlugin=a.PicSource=void 0;const _=d(126),g=d(856),y=v(d(607)),P=d(913);class u{constructor(o){this.ctx=o,this.tags=[],this.weight=1,this.name="default",this.description="",this.isDefault=!1}applyConfig(o){this.name=o.name,this.tags??=o.tags,this.weight??=o.weight,this.description??=o.description,this.isDefault??=o.isDefault}randomPic(o){throw new Error("Not implemented")}onStartup(){}onShutdown(){}getDisplayString(){let o=this.name;return this.tags.length&&(o+=`	\u6807\u7B7E: ${this.tags.join(",")}`),this.description&&(o+=`	${this.description}`),o}}b(u,"PicSource"),a.PicSource=u;let s=b(class extends u{constructor(o,p){super(o)}initializeSource(){this.config.applyTo(this),this.pics.addSource(this)}},"BasePicSourcePlugin");m([(0,g.InjectConfig)(),f("design:type",P.PicSourceConfig)],s.prototype,"config",void 0),m([(0,g.Inject)(!0),f("design:type",y.default)],s.prototype,"pics",void 0),m([(0,g.InjectLogger)(),f("design:type",_.Logger)],s.prototype,"logger",void 0),m([(0,g.Apply)(),f("design:type",Function),f("design:paramtypes",[]),f("design:returntype",void 0)],s.prototype,"initializeSource",null),s=m([(0,g.Reusable)(),f("design:paramtypes",[_.Context,Object])],s),a.BasePicSourcePlugin=s,a.PicSourcePlugin=(0,g.CreatePluginFactory)(s,P.PicSourceConfig);function l(t){var o;const p=(0,g.schemaFromClass)(P.PicSourceConfig);return Object.assign(p.dict,t),o=b(class extends u{constructor(r,e){super(r),this.config=e,this.applyConfig(e),r.pics.addSource(this)}},"PlainPicSourcePluginBase"),o.Config=p,o.using=["pics"],o.reusable=!0,o}b(l,"PlainPicSourcePlugin"),a.PlainPicSourcePlugin=l},24:S=>{S.exports=require("@koishijs/assets")},126:S=>{S.exports=require("koishi")},856:S=>{S.exports=require("koishi-thirdeye")},517:S=>{S.exports=require("lodash")}},M={};function D(S){var a=M[S];if(a!==void 0)return a.exports;var d=M[S]={exports:{}};return C[S].call(d.exports,d,d.exports,D),d.exports}b(D,"__webpack_require__");var R=D(607),B=exports;for(var A in R)B[A]=R[A];R.__esModule&&Object.defineProperty(B,"__esModule",{value:!0})})();

//# sourceMappingURL=index.js.map