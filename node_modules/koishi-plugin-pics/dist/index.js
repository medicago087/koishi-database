var $=Object.defineProperty;var b=(C,M)=>$(C,"name",{value:M,configurable:!0});(()=>{"use strict";var C={913:function(_,a,d){var y=this&&this.__decorate||function(l,s,u,t){var n=arguments.length,m=n<3?s:t===null?t=Object.getOwnPropertyDescriptor(s,u):t,h;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")m=Reflect.decorate(l,s,u,t);else for(var r=l.length-1;r>=0;r--)(h=l[r])&&(m=(n<3?h(m):n>3?h(s,u,m):h(s,u))||m);return n>3&&m&&Object.defineProperty(s,u,m),m},f=this&&this.__metadata||function(l,s){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(l,s)};Object.defineProperty(a,"__esModule",{value:!0}),a.PicMiddlewareConfig=a.PicSourceConfig=a.PicsPluginConfig=void 0;const v=d(856),w=d(126);let p=b(class{constructor(s){}},"PicsPluginConfig");y([(0,v.SchemaProperty)({description:"\u6307\u4EE4\u540D",default:"pic",hidden:!0}),f("design:type",String)],p.prototype,"commandName",void 0),y([(0,v.SchemaProperty)({description:"Assets \u670D\u52A1\u53EF\u7528\u65F6\uFF0C\u4F7F\u7528 Assets \u7F13\u5B58\u56FE\u7247\u3002",default:!0}),f("design:type",Boolean)],p.prototype,"useAssets",void 0),y([(0,v.SchemaProperty)({description:"\u4F7F\u7528 Base64 \u53D1\u9001\u56FE\u7247\u7ED3\u679C\u3002",default:!1}),f("design:type",Boolean)],p.prototype,"useBase64",void 0),y([(0,v.SchemaProperty)({type:w.Schema.object({}),default:{}}),f("design:type",w.Quester.Config)],p.prototype,"httpConfig",void 0),y([(0,v.SchemaProperty)({description:"OneBot \u673A\u5668\u4EBA\u6C38\u8FDC\u4F7F\u7528 file \u5B57\u6BB5\u3002",default:!1}),f("design:type",Boolean)],p.prototype,"preferFile",void 0),p=y([(0,v.RegisterSchema)(),f("design:paramtypes",[Object])],p),a.PicsPluginConfig=p;class g{applyTo(s){s.tags=this.tags,s.weight=this.weight,s.name=this.name,s.description=this.description,s.isDefault=this.isDefault}}b(g,"PicSourceConfig"),y([(0,v.SchemaProperty)({type:"string",default:[],description:"\u56FE\u6E90\u6807\u7B7E"}),f("design:type",Array)],g.prototype,"tags",void 0),y([(0,v.SchemaProperty)({default:1,description:"\u56FE\u6E90\u6743\u91CD"}),f("design:type",Number)],g.prototype,"weight",void 0),y([(0,v.SchemaProperty)({description:"\u56FE\u6E90\u540D\u79F0",required:!0}),f("design:type",String)],g.prototype,"name",void 0),y([(0,v.SchemaProperty)({description:"\u56FE\u6E90\u63CF\u8FF0"}),f("design:type",String)],g.prototype,"description",void 0),y([(0,v.SchemaProperty)({description:"\u662F\u5426\u4E3A\u9ED8\u8BA4\u56FE\u6E90"}),f("design:type",Boolean)],g.prototype,"isDefault",void 0),a.PicSourceConfig=g;class P{constructor(s){}applyTo(s){s.name=this.name,s.prepend=this.prepend}}b(P,"PicMiddlewareConfig"),y([(0,v.SchemaProperty)({description:"\u4E2D\u95F4\u4EF6\u540D\u79F0\u3002"}),f("design:type",String)],P.prototype,"name",void 0),y([(0,v.SchemaProperty)({description:"\u662F\u5426\u5728\u9996\u4F4D\u63D2\u5165\u4E2D\u95F4\u4EF6\u3002",default:!1}),f("design:type",Boolean)],P.prototype,"prepend",void 0),a.PicMiddlewareConfig=P},519:(_,a)=>{Object.defineProperty(a,"__esModule",{value:!0})},607:function(_,a,d){var y=this&&this.__createBinding||(Object.create?function(r,e,i,o){o===void 0&&(o=i);var c=Object.getOwnPropertyDescriptor(e,i);(!c||("get"in c?!e.__esModule:c.writable||c.configurable))&&(c={enumerable:!0,get:function(){return e[i]}}),Object.defineProperty(r,o,c)}:function(r,e,i,o){o===void 0&&(o=i),r[o]=e[i]}),f=this&&this.__decorate||function(r,e,i,o){var c=arguments.length,S=c<3?e:o===null?o=Object.getOwnPropertyDescriptor(e,i):o,j;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")S=Reflect.decorate(r,e,i,o);else for(var O=r.length-1;O>=0;O--)(j=r[O])&&(S=(c<3?j(S):c>3?j(e,i,S):j(e,i))||S);return c>3&&S&&Object.defineProperty(e,i,S),S},v=this&&this.__exportStar||function(r,e){for(var i in r)i!=="default"&&!Object.prototype.hasOwnProperty.call(e,i)&&y(e,r,i)},w=this&&this.__metadata||function(r,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(r,e)},p=this&&this.__param||function(r,e){return function(i,o){e(i,o,r)}},g=this&&this.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(a,"__esModule",{value:!0});const P=d(126),l=d(913),s=g(d(517)),u=d(126),t=d(856),n=d(670),m=d(177);v(d(913),a),v(d(714),a),v(d(310),a),v(d(519),a);let h=b(class extends(0,t.StarterPlugin)(l.PicsPluginConfig){constructor(){super(...arguments),this.sources=new Map,this.picMiddlewares=[]}addSource(e,i){const o=i||this.caller,c=o.on("dispose",()=>this.removeSource(e));this.sources.set(e,c),o.on("ready",()=>e.onStartup()),this.logger.info(`Loaded pic source ${e.name}.`)}async removeSource(e){try{await e.onShutdown()}catch(o){this.logger.warn(`Shutdown of ${e.name} failed: ${o.toString()}`)}const i=this.sources.get(e);this.sources.delete(e),i&&i(),this.logger.info(`Removed pic source ${e.name}.`)}allSources(){return Array.from(this.sources.keys())}middleware(e,i){const o=i||this.caller;e.name||=o.state?.runtime?.plugin?.name;const c=o.on("dispose",()=>{c(),this.removeMiddlware(e)});e.prepend?this.picMiddlewares.unshift(e):this.picMiddlewares.push(e)}removeMiddlware(e){(0,P.remove)(this.picMiddlewares,e)}pickAvailableSources(e=[],i=!1){let o=this.allSources();return e.length?o=o.filter(c=>e.some(S=>c.name===S)||e.every(S=>c.tags.includes(S))):!i&&o.length>1&&(o=o.filter(c=>c.isDefault)),o}randomSourceWithWeight(e=this.allSources()){if(!e.length)return null;if(e.length===1)return e[0];const i=s.default.flatten(e.map(o=>s.default.range(o.weight).map(()=>o)));return P.Random.pick(i)}async retryWithAnotherSource(e,i,o){const c=i.filter(S=>S!==e);return this.fetchPicsWithSources(c,o)}async fetchPicsWithSources(e,i){const o=this.randomSourceWithWeight(e);if(!o)return null;this.logger.debug(`Using source ${o.name} for searching ${i.join(",")}`);try{const c=await o.randomPic(i);return c?(this.logger.debug(`Got pic ${c.url}`),c):(this.logger.debug(`Pic not found from ${o.name}, retrying with another source.`),this.retryWithAnotherSource(o,e,i))}catch(c){return this.logger.warn(`Fetch pic failed from ${o.name}, retrying with another source: ${c.toString()}`),this.retryWithAnotherSource(o,e,i)}}async randomPic(e=[],i=[]){const o=this.pickAvailableSources(i);return this.fetchPicsWithSources(o,e)}isOneBotBot(e){return e&&(e.platform==="onebot"||e.platform==="qqguild"&&e.parentBot?.platform==="onebot")}async urlToBuffer(e,i={}){return e.startsWith("base64://")?Buffer.from(e.slice(9),"base64"):await this._http.get(e,{responseType:"arraybuffer",...i})}bufferToUrl(e){return`base64://${e.toString("base64")}`}async download(e,i={}){if(e.startsWith("base64://"))return e;const o=await this.urlToBuffer(e,i);return this.bufferToUrl(o)}async resolveUrl(e,i=this.picMiddlewares){if(!i.length)return e;const o=b(async c=>(c||=e,await this.resolveUrl(c,i.slice(1))||c),"next");try{let c=await i[0].use(e,o);return c||(this.logger.warn(`Got empty result from middleware ${i[0].name||"???"}`),c=e),c}catch(c){return this.logger.warn(`Resolve url ${e} failed: ${c.toString()}`),e}}async getSegment(e){return e=await this.resolveUrl(e),u.segment.image(e)}installDefaultMiddlewares(){this.config.useAssets&&this.ctx.plugin(n.PicAssetsTransformMiddleware),this.config.useBase64&&this.ctx.plugin(m.PicDownloaderMiddleware)}async onPic(e,i,o){const c=e?.split(/[ ,+\uFF0C\uFF0B\u3001]/)||[];i||=[];const S=await this.randomPic(i,c);if(!S)return o();let j=(await this.getSegment(S.url)).toString();return S.description&&(j+=`
${S.description}`),j}async onQuerySource(e,i){e||=[];const o=this.pickAvailableSources(e,!0);return`${i()}
${o.map(c=>c.getDisplayString()).join(`
`)}`}onApply(){this._http=this.http.extend(this.config.httpConfig),this.installDefaultMiddlewares()}},"PicsContainer");f([(0,t.Caller)(),w("design:type",P.Context)],h.prototype,"caller",void 0),f([(0,t.InjectLogger)(),w("design:type",P.Logger)],h.prototype,"logger",void 0),f([(0,t.Inject)(!0),w("design:type",u.Quester)],h.prototype,"http",void 0),f([(0,t.UseCommand)("{{commandName}} [...tags:string]"),(0,t.CommandLocale)("zh",{description:"\u83B7\u53D6\u968F\u673A\u56FE\u7247",options:{source:"\u6307\u5B9A\u56FE\u6E90\uFF0C\u9017\u53F7\u5206\u9694\u3002\u56FE\u6E90\u53EF\u4EE5\u7528 {{commandName}}.sources \u67E5\u8BE2\u3002"},usage:"\u4ECE\u5404\u4E2A\u56FE\u6E90\u4E2D\u968F\u673A\u83B7\u53D6\u4E00\u5F20\u968F\u673A\u56FE\u7247\u3002\u56FE\u6E90\u53EF\u4EE5\u7528 {{commandName}}.sources \u67E5\u8BE2\u3002\u53C2\u6570\u5747\u4E3A\u53EF\u9009\u3002",messages:{"not-found":"\u672A\u627E\u5230\u4EFB\u4F55\u56FE\u7247\u3002"}}),(0,t.CommandLocale)("en",{description:"Get random picture",options:{source:"Specify the source, separated by comma. You can query the sources with {{commandName}}.sources."},usage:"Get a random picture from a random source. Sources can be queried with command {{commandName}}.sources",messages:{"not-found":"No pictures found."}}),(0,t.CommandExample)("{{commandName}}"),(0,t.CommandExample)("{{commandName}} yuyuko"),(0,t.CommandExample)("{{commandName}} -s yande"),(0,t.CommandExample)("{{commandName}} -s yande yuyuko saigyouji"),p(0,(0,t.PutOption)("source","-s <source>")),p(1,(0,t.PutArgs)()),p(2,(0,t.PutRenderer)(".not-found")),w("design:type",Function),w("design:paramtypes",[String,Array,Function]),w("design:returntype",Promise)],h.prototype,"onPic",null),f([(0,t.UseCommand)("{{commandName}}.sources"),(0,t.CommandLocale)("zh",{description:"\u67E5\u8BE2\u56FE\u6E90\u5217\u8868",options:{},usage:"\u56FE\u6E90\u6807\u7B7E\u53EF\u7528\u4E8E\u56FE\u7247\u83B7\u53D6\u7684\u56FE\u6E90\u7B5B\u9009\u3002",messages:{list:"\u56FE\u6E90\u7684\u5217\u8868\u5982\u4E0B:"}}),(0,t.CommandLocale)("en",{description:"Query picture sources",options:{},usage:"Source tags can be used to filter picture sources.",messages:{list:"List of sources:"}}),(0,t.CommandExample)("{{commandName}}.sources"),(0,t.CommandExample)("{{commandName}}.sources pixiv"),p(0,(0,t.PutArgs)()),p(1,(0,t.PutRenderer)(".list")),w("design:type",Function),w("design:paramtypes",[Array,Function]),w("design:returntype",Promise)],h.prototype,"onQuerySource",null),h=f([(0,t.Provide)("pics",{immediate:!0}),(0,t.DefinePlugin)({name:"pics"})],h),a.default=h},714:function(_,a,d){var y=this&&this.__decorate||function(u,t,n,m){var h=arguments.length,r=h<3?t:m===null?m=Object.getOwnPropertyDescriptor(t,n):m,e;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(u,t,n,m);else for(var i=u.length-1;i>=0;i--)(e=u[i])&&(r=(h<3?e(r):h>3?e(t,n,r):e(t,n))||r);return h>3&&r&&Object.defineProperty(t,n,r),r},f=this&&this.__metadata||function(u,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(u,t)},v=this&&this.__importDefault||function(u){return u&&u.__esModule?u:{default:u}};Object.defineProperty(a,"__esModule",{value:!0}),a.PlainPicMiddlewarePlugin=a.PicMiddlewarePlugin=a.BasePicMiddlewarePlugin=void 0;const w=d(126),p=d(913),g=d(856),P=v(d(607));let l=b(class extends(0,g.StarterPlugin)(p.PicMiddlewareConfig){onApply(){this.config.applyTo(this),this.pics.middleware(this)}use(t,n){return n(t)}},"BasePicMiddlewarePlugin");y([(0,g.Inject)(!0),f("design:type",P.default)],l.prototype,"pics",void 0),y([(0,g.InjectLogger)(),f("design:type",w.Logger)],l.prototype,"logger",void 0),l=y([(0,g.Reusable)()],l),a.BasePicMiddlewarePlugin=l,a.PicMiddlewarePlugin=(0,g.CreatePluginFactory)(l,p.PicMiddlewareConfig);function s(u){var t;const n=(0,g.schemaFromClass)(p.PicMiddlewareConfig);return Object.assign(n.dict,u),t=b(class{constructor(h,r){this.ctx=h,this.config=r,this.name=r.name,this.prepend=r.prepend,h.pics.middleware(this)}use(h,r){return r(h)}},"PlainPicMiddlewarePluginBase"),t.Config=n,t.using=["pics"],t.reusable=!0,t}b(s,"PlainPicMiddlewarePlugin"),a.PlainPicMiddlewarePlugin=s},670:function(_,a,d){var y=this&&this.__decorate||function(P,l,s,u){var t=arguments.length,n=t<3?l:u===null?u=Object.getOwnPropertyDescriptor(l,s):u,m;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(P,l,s,u);else for(var h=P.length-1;h>=0;h--)(m=P[h])&&(n=(t<3?m(n):t>3?m(l,s,n):m(l,s))||n);return t>3&&n&&Object.defineProperty(l,s,n),n},f=this&&this.__metadata||function(P,l){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(P,l)};Object.defineProperty(a,"__esModule",{value:!0}),a.PicAssetsTransformMiddleware=void 0;const v=d(856),w=d(126),p=d(714);let g=b(class extends(0,p.PicMiddlewarePlugin)(){async use(l,s){const u=await s(l);return this.assets?this.assets.upload(u,void 0):u}},"PicAssetsTransformMiddleware");y([(0,v.Inject)(),f("design:type",w.Assets)],g.prototype,"assets",void 0),g=y([(0,v.DefinePlugin)()],g),a.PicAssetsTransformMiddleware=g},177:function(_,a,d){var y=this&&this.__decorate||function(p,g,P,l){var s=arguments.length,u=s<3?g:l===null?l=Object.getOwnPropertyDescriptor(g,P):l,t;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")u=Reflect.decorate(p,g,P,l);else for(var n=p.length-1;n>=0;n--)(t=p[n])&&(u=(s<3?t(u):s>3?t(g,P,u):t(g,P))||u);return s>3&&u&&Object.defineProperty(g,P,u),u};Object.defineProperty(a,"__esModule",{value:!0}),a.PicDownloaderMiddleware=void 0;const f=d(856),v=d(714);let w=b(class extends(0,v.PicMiddlewarePlugin)(){async use(g,P){const l=await this.pics.download(g);return P(l)}},"PicDownloaderMiddleware");w=y([(0,f.DefinePlugin)()],w),a.PicDownloaderMiddleware=w},310:function(_,a,d){var y=this&&this.__decorate||function(t,n,m,h){var r=arguments.length,e=r<3?n:h===null?h=Object.getOwnPropertyDescriptor(n,m):h,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")e=Reflect.decorate(t,n,m,h);else for(var o=t.length-1;o>=0;o--)(i=t[o])&&(e=(r<3?i(e):r>3?i(n,m,e):i(n,m))||e);return r>3&&e&&Object.defineProperty(n,m,e),e},f=this&&this.__metadata||function(t,n){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(t,n)},v=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(a,"__esModule",{value:!0}),a.PlainPicSourcePlugin=a.PicSourcePlugin=a.BasePicSourcePlugin=a.PicSource=void 0;const w=d(126),p=d(856),g=v(d(607)),P=d(913);class l{constructor(n){this.ctx=n,this.tags=[],this.weight=1,this.name="default",this.description="",this.isDefault=!1}applyConfig(n){this.name=n.name,this.tags??=n.tags,this.weight??=n.weight,this.description??=n.description,this.isDefault??=n.isDefault}randomPic(n){throw new Error("Not implemented")}onStartup(){}onShutdown(){}getDisplayString(){let n=this.name;return this.tags.length&&(n+=`	\u6807\u7B7E: ${this.tags.join(",")}`),this.description&&(n+=`	${this.description}`),n}}b(l,"PicSource"),a.PicSource=l;let s=b(class extends l{constructor(n,m){super(n)}initializeSource(){this.config.applyTo(this),this.pics.addSource(this)}},"BasePicSourcePlugin");y([(0,p.InjectConfig)(),f("design:type",P.PicSourceConfig)],s.prototype,"config",void 0),y([(0,p.Inject)(!0),f("design:type",g.default)],s.prototype,"pics",void 0),y([(0,p.InjectLogger)(),f("design:type",w.Logger)],s.prototype,"logger",void 0),y([(0,p.Apply)(),f("design:type",Function),f("design:paramtypes",[]),f("design:returntype",void 0)],s.prototype,"initializeSource",null),s=y([(0,p.Reusable)(),f("design:paramtypes",[w.Context,Object])],s),a.BasePicSourcePlugin=s,a.PicSourcePlugin=(0,p.CreatePluginFactory)(s,P.PicSourceConfig);function u(t){var n;const m=(0,p.schemaFromClass)(P.PicSourceConfig);return Object.assign(m.dict,t),n=b(class extends l{constructor(r,e){super(r),this.config=e,this.applyConfig(e),r.pics.addSource(this)}},"PlainPicSourcePluginBase"),n.Config=m,n.using=["pics"],n.reusable=!0,n}b(u,"PlainPicSourcePlugin"),a.PlainPicSourcePlugin=u},126:_=>{_.exports=require("koishi")},856:_=>{_.exports=require("koishi-thirdeye")},517:_=>{_.exports=require("lodash")}},M={};function D(_){var a=M[_];if(a!==void 0)return a.exports;var d=M[_]={exports:{}};return C[_].call(d.exports,d,d.exports,D),d.exports}b(D,"__webpack_require__");var R=D(607),B=exports;for(var A in R)B[A]=R[A];R.__esModule&&Object.defineProperty(B,"__esModule",{value:!0})})();

//# sourceMappingURL=index.js.map