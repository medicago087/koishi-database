import { createStorage as T, store as _, router as E, message as b, send as z, Schema as L, icons as x } from "../client.js";
import { ref as A, watch as I, defineComponent as S, resolveComponent as m, openBlock as r, createElementBlock as i, Fragment as V, unref as n, createElementVNode as c, toDisplayString as $, createVNode as l, withCtx as a, createTextVNode as w, createCommentVNode as H, withKeys as K, withModifiers as O, createBlock as U, computed as j, renderList as N, isRef as R } from "../vue.js";
import { useRouter as W } from "../vue-router.js";
const t = T("auth", 1, () => ({
  authType: 0
})), B = A(!1);
I(() => _.user, (s, e) => {
  if (B.value = !1, !s)
    return E.push("/login");
  if (e)
    return;
  b.success(`\u6B22\u8FCE\u56DE\u6765\uFF0C${s.name || "Koishi \u7528\u6237"}\uFF01`), Object.assign(t, s);
  const o = E.currentRoute.value.redirectedFrom;
  o && !o.path.startsWith("/login") ? E.push(o) : E.push("/profile");
});
const q = { class: "login-form" }, G = { key: 0 }, J = /* @__PURE__ */ c("span", null, "\u5E73\u53F0\u8D26\u6237\u7ED1\u5B9A", -1), Q = [
  J
], X = { key: 1 }, Y = /* @__PURE__ */ c("span", null, "\u5E73\u53F0\u8D26\u6237\u767B\u5F55", -1), Z = [
  Y
], ee = { class: "hint" }, te = /* @__PURE__ */ c("p", { class: "hint" }, "\u8BF7\u7528\u4E0A\u8FF0\u8D26\u53F7\u5C06\u4E0B\u9762\u7684\u9A8C\u8BC1\u7801\u53D1\u9001\u7ED9\u4EFB\u610F\u6B63\u5728\u8FD0\u884C\u7684\u673A\u5668\u4EBA", -1), oe = { class: "token" }, se = { class: "control" }, ne = { key: 0 }, ue = /* @__PURE__ */ c("span", null, "\u5E73\u53F0\u8D26\u6237\u7ED1\u5B9A", -1), le = [
  ue
], re = {
  key: 0,
  class: "error"
}, ce = { class: "control" }, ie = {
  key: 0,
  class: "error"
}, ae = { class: "control" }, P = /* @__PURE__ */ S({
  __name: "login-form",
  setup(s) {
    const e = A(), o = A();
    let f = 0;
    async function g() {
      var y;
      const k = Date.now();
      if (k < f)
        return;
      const { platform: u, userId: d } = t;
      if (!(!u || !d)) {
        f = k + 1e3;
        try {
          o.value = await z("login/platform", u, d, (y = _.user) == null ? void 0 : y.id);
        } catch (p) {
          e.value = p.message;
        }
      }
    }
    async function M() {
      const { name: k, password: u } = t;
      try {
        await z("login/password", k, u);
      } catch (d) {
        e.value = d.message;
      }
    }
    const v = W();
    function C() {
      _.user ? B.value = !1 : v.back();
    }
    return (k, u) => {
      const d = m("k-button"), y = m("k-tab"), p = m("k-icon"), F = m("el-input");
      return r(), i("div", q, [
        o.value ? (r(), i(V, { key: 0 }, [
          n(_).user ? (r(), i("h1", G, Q)) : (r(), i("h1", X, Z)),
          c("p", ee, "\u6B22\u8FCE\u4F60\uFF0C" + $(o.value.name || "Koishi \u7528\u6237") + "\uFF01", 1),
          te,
          c("p", oe, $(o.value.token), 1),
          c("div", se, [
            l(d, {
              onClick: u[0] || (u[0] = (h) => o.value.token = null)
            }, {
              default: a(() => [
                w("\u8FD4\u56DE\u4E0A\u4E00\u6B65")
              ]),
              _: 1
            })
          ])
        ], 64)) : (r(), i(V, { key: 1 }, [
          n(_).user ? (r(), i("h1", ne, le)) : H("", !0),
          c("h1", null, [
            l(y, {
              data: ["\u5E73\u53F0\u8D26\u6237\u767B\u5F55", "\u7528\u6237\u540D\u5BC6\u7801\u767B\u5F55"],
              modelValue: n(t).authType,
              "onUpdate:modelValue": u[1] || (u[1] = (h) => n(t).authType = h)
            }, null, 8, ["modelValue"])
          ]),
          n(_).user || n(t).authType === 0 ? (r(), i(V, { key: 1 }, [
            l(F, {
              placeholder: "\u5E73\u53F0\u540D",
              modelValue: n(t).platform,
              "onUpdate:modelValue": u[2] || (u[2] = (h) => n(t).platform = h)
            }, {
              prefix: a(() => [
                l(p, { name: "at" })
              ]),
              _: 1
            }, 8, ["modelValue"]),
            l(F, {
              placeholder: "\u8D26\u53F7",
              modelValue: n(t).userId,
              "onUpdate:modelValue": u[3] || (u[3] = (h) => n(t).userId = h),
              onKeypress: K(O(g, ["stop"]), ["enter"])
            }, {
              prefix: a(() => [
                l(p, { name: "user" })
              ]),
              _: 1
            }, 8, ["modelValue", "onKeypress"]),
            e.value ? (r(), i("p", re, $(e.value), 1)) : H("", !0),
            c("div", ce, [
              l(d, { onClick: C }, {
                default: a(() => [
                  w("\u8FD4\u56DE")
                ]),
                _: 1
              }),
              l(d, { onClick: g }, {
                default: a(() => [
                  w("\u83B7\u53D6\u9A8C\u8BC1\u7801")
                ]),
                _: 1
              })
            ])
          ], 64)) : (r(), i(V, { key: 2 }, [
            l(F, {
              placeholder: "\u7528\u6237\u540D",
              modelValue: n(t).name,
              "onUpdate:modelValue": u[4] || (u[4] = (h) => n(t).name = h)
            }, {
              prefix: a(() => [
                l(p, { name: "user" })
              ]),
              _: 1
            }, 8, ["modelValue"]),
            l(F, {
              placeholder: "\u5BC6\u7801",
              modelValue: n(t).password,
              "onUpdate:modelValue": u[6] || (u[6] = (h) => n(t).password = h),
              onKeypress: K(O(M, ["stop"]), ["enter"]),
              type: n(t).showPass ? "text" : "password"
            }, {
              prefix: a(() => [
                l(p, { name: "lock" })
              ]),
              suffix: a(() => [
                l(p, {
                  name: n(t).showPass ? "eye" : "eye-slash",
                  onClick: u[5] || (u[5] = (h) => n(t).showPass = !n(t).showPass)
                }, null, 8, ["name"])
              ]),
              _: 1
            }, 8, ["modelValue", "onKeypress", "type"]),
            e.value ? (r(), i("p", ie, $(e.value), 1)) : H("", !0),
            c("div", ae, [
              l(d, { onClick: C }, {
                default: a(() => [
                  w("\u8FD4\u56DE")
                ]),
                _: 1
              }),
              l(d, { onClick: M }, {
                default: a(() => [
                  w("\u767B\u5F55")
                ]),
                _: 1
              })
            ])
          ], 64))
        ], 64))
      ]);
    };
  }
});
const _e = /* @__PURE__ */ S({
  __name: "login",
  setup(s) {
    return (e, o) => {
      const f = m("k-card"), g = m("k-layout");
      return r(), U(g, { main: "darker page-login" }, {
        default: a(() => [
          l(f, null, {
            default: a(() => [
              l(P)
            ]),
            _: 1
          })
        ]),
        _: 1
      });
    };
  }
});
const de = { class: "k-schema-header" }, pe = { class: "schema-item" }, he = { class: "header" }, me = { class: "left" }, fe = /* @__PURE__ */ c("div", { class: "right" }, null, -1), ge = /* @__PURE__ */ S({
  __name: "profile",
  setup(s) {
    const e = A({}), o = j(() => {
      const v = L.object({
        name: L.string().description("\u7528\u6237\u540D").default(t.name)
      }).description("\u57FA\u672C\u8D44\u6599");
      return v.dict.password = L.string().role("secret").description("\u5BC6\u7801").default(t.password), v;
    });
    async function f() {
      return delete t.id, delete t.token, delete t.expire, z("user/logout");
    }
    async function g() {
      try {
        await z("user/update", e.value), b.success("\u4FEE\u6539\u6210\u529F\uFF01"), Object.assign(t, e), Object.assign(_.user, e.value), e.value = {};
      } catch (v) {
        b.error(v.message);
      }
    }
    const M = j(() => [{
      icon: "check",
      label: "\u5E94\u7528\u66F4\u6539",
      disabled: !e.value || !Object.keys(e.value).length,
      action: g
    }, {
      type: "error",
      icon: "sign-out",
      label: "\u9000\u51FA\u767B\u5F55",
      action: f
    }]);
    return (v, C) => {
      const k = m("el-button"), u = m("k-form"), d = m("k-content"), y = m("k-layout");
      return r(), U(y, {
        main: "page-profile",
        menu: n(M)
      }, {
        default: a(() => [
          l(d, null, {
            default: a(() => [
              l(u, {
                schema: n(o),
                modelValue: e.value,
                "onUpdate:modelValue": C[1] || (C[1] = (p) => e.value = p)
              }, {
                epilog: a(() => [
                  c("h2", de, [
                    w(" \u5E73\u53F0\u8D26\u6237\u7ED1\u5B9A "),
                    l(k, {
                      solid: "",
                      onClick: C[0] || (C[0] = (p) => B.value = !0)
                    }, {
                      default: a(() => [
                        w("\u6DFB\u52A0")
                      ]),
                      _: 1
                    })
                  ]),
                  (r(!0), i(V, null, N(n(_).user.accounts, ({ platform: p, id: F }) => (r(), i("div", pe, [
                    c("div", he, [
                      c("div", me, $(p) + " (" + $(F) + ")", 1),
                      fe
                    ])
                  ]))), 256))
                ]),
                _: 1
              }, 8, ["schema", "modelValue"])
            ]),
            _: 1
          })
        ]),
        _: 1
      }, 8, ["menu"]);
    };
  }
});
const D = (s, e) => {
  const o = s.__vccOpts || s;
  for (const [f, g] of e)
    o[f] = g;
  return o;
}, ve = {}, Ce = {
  class: "k-icon k-icon-at",
  xmlns: "http://www.w3.org/2000/svg",
  viewBox: "0 0 512 512"
}, ke = /* @__PURE__ */ c("path", {
  fill: "currentColor",
  d: "M256 8C118.941 8 8 118.919 8 256c0 137.059 110.919 248 248 248 48.154 0 95.342-14.14 135.408-40.223 12.005-7.815 14.625-24.288 5.552-35.372l-10.177-12.433c-7.671-9.371-21.179-11.667-31.373-5.129C325.92 429.757 291.314 440 256 440c-101.458 0-184-82.542-184-184S154.542 72 256 72c100.139 0 184 57.619 184 160 0 38.786-21.093 79.742-58.17 83.693-17.349-.454-16.91-12.857-13.476-30.024l23.433-121.11C394.653 149.75 383.308 136 368.225 136h-44.981a13.518 13.518 0 0 0-13.432 11.993l-.01.092c-14.697-17.901-40.448-21.775-59.971-21.775-74.58 0-137.831 62.234-137.831 151.46 0 65.303 36.785 105.87 96 105.87 26.984 0 57.369-15.637 74.991-38.333 9.522 34.104 40.613 34.103 70.71 34.103C462.609 379.41 504 307.798 504 232 504 95.653 394.023 8 256 8zm-21.68 304.43c-22.249 0-36.07-15.623-36.07-40.771 0-44.993 30.779-72.729 58.63-72.729 22.292 0 35.601 15.241 35.601 40.77 0 45.061-33.875 72.73-58.161 72.73z"
}, null, -1), we = [
  ke
];
function ye(s, e) {
  return r(), i("svg", Ce, we);
}
const Fe = /* @__PURE__ */ D(ve, [["render", ye]]), $e = {}, Be = {
  class: "k-icon check",
  xmlns: "http://www.w3.org/2000/svg",
  viewBox: "0 0 448 512"
}, xe = /* @__PURE__ */ c("path", {
  fill: "currentColor",
  d: "M438.6 105.4C451.1 117.9 451.1 138.1 438.6 150.6L182.6 406.6C170.1 419.1 149.9 419.1 137.4 406.6L9.372 278.6C-3.124 266.1-3.124 245.9 9.372 233.4C21.87 220.9 42.13 220.9 54.63 233.4L159.1 338.7L393.4 105.4C405.9 92.88 426.1 92.88 438.6 105.4H438.6z"
}, null, -1), De = [
  xe
];
function Ee(s, e) {
  return r(), i("svg", Be, De);
}
const Ve = /* @__PURE__ */ D($e, [["render", Ee]]), be = {}, ze = {
  class: "k-icon k-icon-lock",
  xmlns: "http://www.w3.org/2000/svg",
  viewBox: "0 0 448 512"
}, Me = /* @__PURE__ */ c("path", {
  fill: "currentColor",
  d: "M400 224h-24v-72C376 68.2 307.8 0 224 0S72 68.2 72 152v72H48c-26.5 0-48 21.5-48 48v192c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V272c0-26.5-21.5-48-48-48zm-104 0H152v-72c0-39.7 32.3-72 72-72s72 32.3 72 72v72z"
}, null, -1), Ae = [
  Me
];
function Se(s, e) {
  return r(), i("svg", ze, Ae);
}
const Le = /* @__PURE__ */ D(be, [["render", Se]]), He = {}, Ue = {
  class: "k-icon k-icon-sign-in",
  xmlns: "http://www.w3.org/2000/svg",
  viewBox: "0 0 512 512"
}, Ke = /* @__PURE__ */ c("path", {
  fill: "currentColor",
  d: "M384 256c0-8.188-3.125-16.38-9.375-22.62l-128-128C237.5 96.22 223.7 93.47 211.8 98.44C199.8 103.4 192 115.1 192 128v64H48C21.49 192 0 213.5 0 240v32C0 298.5 21.49 320 48 320H192v64c0 12.94 7.797 24.62 19.75 29.56c11.97 4.969 25.72 2.219 34.88-6.938l128-128C380.9 272.4 384 264.2 384 256zM224 384V288H48C39.18 288 32 280.8 32 272v-32C32 231.2 39.18 224 48 224H224L223.1 128l128 128L224 384zM432 32h-96C327.2 32 320 39.16 320 48S327.2 64 336 64h96C458.5 64 480 85.53 480 112v288c0 26.47-21.53 48-48 48h-96c-8.844 0-16 7.156-16 16s7.156 16 16 16h96c44.13 0 80-35.88 80-80v-288C512 67.88 476.1 32 432 32z"
}, null, -1), Oe = [
  Ke
];
function je(s, e) {
  return r(), i("svg", Ue, Oe);
}
const Pe = /* @__PURE__ */ D(He, [["render", je]]), Te = {}, Ie = {
  class: "k-icon k-icon-sign-out",
  xmlns: "http://www.w3.org/2000/svg",
  viewBox: "0 0 512 512"
}, Ne = /* @__PURE__ */ c("path", {
  fill: "currentColor",
  d: "M176 448h-96C53.53 448 32 426.5 32 400v-288C32 85.53 53.53 64 80 64h96C184.8 64 192 56.84 192 48S184.8 32 176 32h-96C35.88 32 0 67.88 0 112v288C0 444.1 35.88 480 80 480h96C184.8 480 192 472.8 192 464S184.8 448 176 448zM502.6 233.4l-128-128c-9.156-9.156-22.91-11.91-34.88-6.938C327.8 103.4 320 115.1 320 128l.0918 63.1L176 192C149.5 192 128 213.5 128 240v32C128 298.5 149.5 320 176 320l144.1-.001L320 384c0 12.94 7.797 24.62 19.75 29.56c11.97 4.969 25.72 2.219 34.88-6.938l128-128C508.9 272.4 512 264.2 512 256S508.9 239.6 502.6 233.4zM352 384V288H176C167.2 288 160 280.8 160 272v-32C160 231.2 167.2 224 176 224H352l-.0039-96l128 128L352 384z"
}, null, -1), Re = [
  Ne
];
function We(s, e) {
  return r(), i("svg", Ie, Re);
}
const qe = /* @__PURE__ */ D(Te, [["render", We]]), Ge = {}, Je = {
  class: "k-icon",
  xmlns: "http://www.w3.org/2000/svg",
  viewBox: "0 0 512 512"
}, Qe = /* @__PURE__ */ c("path", {
  fill: "currentColor",
  d: "M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256s256-114.6 256-256S397.4 0 256 0zM256 480c-47.24 0-91.04-14.78-127.2-39.84C132.9 390.9 173.8 352 224 352h64c50.25 0 91.14 38.94 95.21 88.16C347 465.2 303.2 480 256 480zM411.7 416.7C397.6 361.3 347.7 320 288 320H224c-59.73 0-109.6 41.3-123.7 96.72C58.27 375.1 32 319 32 256c0-123.5 100.5-224 224-224s224 100.5 224 224C480 319 453.7 375.1 411.7 416.7zM256 128C211.8 128 176 163.8 176 208C176 252.2 211.8 288 256 288s80-35.82 80-80C336 163.8 300.2 128 256 128zM256 256C229.5 256 208 234.5 208 208S229.5 160 256 160s48 21.53 48 48S282.5 256 256 256z"
}, null, -1), Xe = [
  Qe
];
function Ye(s, e) {
  return r(), i("svg", Je, Xe);
}
const Ze = /* @__PURE__ */ D(Ge, [["render", Ye]]), et = /* @__PURE__ */ S({
  __name: "bind-dialog",
  setup(s) {
    return (e, o) => {
      const f = m("el-dialog");
      return r(), U(f, {
        center: "",
        modelValue: n(B),
        "onUpdate:modelValue": o[0] || (o[0] = (g) => R(B) ? B.value = g : null),
        class: "bind-dialog"
      }, {
        default: a(() => [
          l(P)
        ]),
        _: 1
      }, 8, ["modelValue"]);
    };
  }
});
x.register("at", Fe);
x.register("check", Ve);
x.register("lock", Le);
x.register("sign-in", Pe);
x.register("sign-out", qe);
x.register("user-full", Ze);
const nt = (s) => {
  t.token && t.expire > Date.now() && z("login/token", t.id, t.token).catch((e) => b.error(e.message)), s.on("activity", (e) => e.authority > 0 && (!_.user || _.user.authority < e.authority)), s.state.disposables.push(E.beforeEach((e) => {
    const { activity: o } = e.meta;
    if (!!o) {
      if ((o.authority || o.fields.includes("user")) && !_.user)
        return history.state.forward === "/login" ? "/" : "/login";
      if (o.authority && o.authority > _.user.authority)
        return b.error("\u6743\u9650\u4E0D\u8DB3\u3002"), !1;
    }
  })), s.page({
    path: "/login",
    name: "\u767B\u5F55",
    icon: "sign-in",
    position: "bottom",
    order: 500,
    when: () => !_.user,
    component: _e
  }), s.page({
    path: "/profile",
    name: "\u7528\u6237\u8D44\u6599",
    icon: "user-full",
    fields: ["user"],
    position: "bottom",
    order: 500,
    component: ge
  }), s.slot({
    type: "global",
    component: et
  });
};
export {
  nt as default
};
