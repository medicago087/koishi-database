{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourcesContent": ["import { Awaitable, Context, Schema, Session } from 'koishi'\n\ntype RequestHandler = number | GeneralHandler\ntype GeneralHandler = string | boolean | ((session: Session) => Awaitable<string | boolean | void>)\ntype Response = [approve: boolean, comment?: string]\n\nconst RequestHandler: Schema<RequestHandler> = Schema.union([\n  Schema.const(undefined).description('无操作'),\n  Schema.const(true).description('全部通过'),\n  Schema.const(false).description('全部拒绝'),\n  Schema.natural().description('权限等级').default(0),\n  Schema.string().hidden(),\n  Schema.function().hidden(),\n])\n\nasync function useGeneralHandler(handler: GeneralHandler, session: Session, prefer: boolean): Promise<Response> {\n  const result = typeof handler === 'function' ? await handler(session) : handler\n  if (typeof result === 'string') {\n    return [prefer, result]\n  } else if (typeof result === 'boolean') {\n    return [result]\n  }\n}\n\nasync function checkUserAuthority(session: Session, authority: number): Promise<Response> {\n  const user = await session.observeUser(['authority'])\n  if (user.authority >= authority) return [true]\n}\n\nasync function checkChannelAuthority(session: Session, authority: number): Promise<Response> {\n  const channel = await session.observeChannel(['assignee'])\n  if (channel.assignee) return [true]\n  const user = await session.observeUser(['authority'])\n  if (user.authority >= authority) {\n    channel.assignee = session.selfId\n    await channel.$update()\n    return [true]\n  }\n}\n\nexport const name = 'verifier'\n\nexport interface Config {\n  onFriendRequest?: RequestHandler\n  onGuildMemberRequest?: RequestHandler\n  onGuildRequest?: RequestHandler\n}\n\nexport const Config: Schema<Config> = Schema.object({\n  onFriendRequest: RequestHandler.description('如何响应好友请求？'),\n  onGuildMemberRequest: RequestHandler.description('如何响应入群申请？'),\n  onGuildRequest: RequestHandler.description('如何响应入群邀请？'),\n})\n\nexport function apply(ctx: Context, config: Config = {}) {\n  const { onFriendRequest, onGuildRequest, onGuildMemberRequest } = config\n\n  ctx.on('friend-request', async (session) => {\n    const result = typeof onFriendRequest === 'number'\n      ? await checkUserAuthority(session, onFriendRequest)\n      : await useGeneralHandler(onFriendRequest, session, true)\n    if (result) return session.bot.handleFriendRequest(session.messageId, ...result)\n  })\n\n  ctx.on('guild-request', async (session) => {\n    const result = typeof onGuildRequest === 'number'\n      ? await checkChannelAuthority(session, onGuildRequest)\n      : await useGeneralHandler(onGuildRequest, session, false)\n    if (result) return session.bot.handleGuildRequest(session.messageId, ...result)\n  })\n\n  ctx.on('guild-member-request', async (session) => {\n    const result = typeof onGuildMemberRequest === 'number'\n      ? await checkUserAuthority(session, onGuildMemberRequest)\n      : await useGeneralHandler(onGuildMemberRequest, session, false)\n    if (result) return session.bot.handleGuildMemberRequest(session.messageId, ...result)\n  })\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBAAoD;AAMpD,IAAM,iBAAyC,qBAAO,MAAM;AAAA,EAC1D,qBAAO,MAAM,MAAS,EAAE,YAAY,KAAK;AAAA,EACzC,qBAAO,MAAM,IAAI,EAAE,YAAY,MAAM;AAAA,EACrC,qBAAO,MAAM,KAAK,EAAE,YAAY,MAAM;AAAA,EACtC,qBAAO,QAAQ,EAAE,YAAY,MAAM,EAAE,QAAQ,CAAC;AAAA,EAC9C,qBAAO,OAAO,EAAE,OAAO;AAAA,EACvB,qBAAO,SAAS,EAAE,OAAO;AAC3B,CAAC;AAED,eAAe,kBAAkB,SAAyB,SAAkB,QAAoC;AAC9G,QAAM,SAAS,OAAO,YAAY,aAAa,MAAM,QAAQ,OAAO,IAAI;AACxE,MAAI,OAAO,WAAW,UAAU;AAC9B,WAAO,CAAC,QAAQ,MAAM;AAAA,EACxB,WAAW,OAAO,WAAW,WAAW;AACtC,WAAO,CAAC,MAAM;AAAA,EAChB;AACF;AAPe;AASf,eAAe,mBAAmB,SAAkB,WAAsC;AACxF,QAAM,OAAO,MAAM,QAAQ,YAAY,CAAC,WAAW,CAAC;AACpD,MAAI,KAAK,aAAa;AAAW,WAAO,CAAC,IAAI;AAC/C;AAHe;AAKf,eAAe,sBAAsB,SAAkB,WAAsC;AAC3F,QAAM,UAAU,MAAM,QAAQ,eAAe,CAAC,UAAU,CAAC;AACzD,MAAI,QAAQ;AAAU,WAAO,CAAC,IAAI;AAClC,QAAM,OAAO,MAAM,QAAQ,YAAY,CAAC,WAAW,CAAC;AACpD,MAAI,KAAK,aAAa,WAAW;AAC/B,YAAQ,WAAW,QAAQ;AAC3B,UAAM,QAAQ,QAAQ;AACtB,WAAO,CAAC,IAAI;AAAA,EACd;AACF;AATe;AAWR,IAAM,OAAO;AAQb,IAAM,SAAyB,qBAAO,OAAO;AAAA,EAClD,iBAAiB,eAAe,YAAY,WAAW;AAAA,EACvD,sBAAsB,eAAe,YAAY,WAAW;AAAA,EAC5D,gBAAgB,eAAe,YAAY,WAAW;AACxD,CAAC;AAEM,SAAS,MAAM,KAAc,SAAiB,CAAC,GAAG;AACvD,QAAM,EAAE,iBAAiB,gBAAgB,qBAAqB,IAAI;AAElE,MAAI,GAAG,kBAAkB,OAAO,YAAY;AAC1C,UAAM,SAAS,OAAO,oBAAoB,WACtC,MAAM,mBAAmB,SAAS,eAAe,IACjD,MAAM,kBAAkB,iBAAiB,SAAS,IAAI;AAC1D,QAAI;AAAQ,aAAO,QAAQ,IAAI,oBAAoB,QAAQ,WAAW,GAAG,MAAM;AAAA,EACjF,CAAC;AAED,MAAI,GAAG,iBAAiB,OAAO,YAAY;AACzC,UAAM,SAAS,OAAO,mBAAmB,WACrC,MAAM,sBAAsB,SAAS,cAAc,IACnD,MAAM,kBAAkB,gBAAgB,SAAS,KAAK;AAC1D,QAAI;AAAQ,aAAO,QAAQ,IAAI,mBAAmB,QAAQ,WAAW,GAAG,MAAM;AAAA,EAChF,CAAC;AAED,MAAI,GAAG,wBAAwB,OAAO,YAAY;AAChD,UAAM,SAAS,OAAO,yBAAyB,WAC3C,MAAM,mBAAmB,SAAS,oBAAoB,IACtD,MAAM,kBAAkB,sBAAsB,SAAS,KAAK;AAChE,QAAI;AAAQ,aAAO,QAAQ,IAAI,yBAAyB,QAAQ,WAAW,GAAG,MAAM;AAAA,EACtF,CAAC;AACH;AAvBgB;",
  "names": []
}
