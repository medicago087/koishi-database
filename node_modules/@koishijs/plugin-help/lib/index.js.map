{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourcesContent": ["import { Argv, Channel, Command, Context, FieldCollector, Schema, segment, Session, Tables, User } from 'koishi'\nimport {} from '@koishijs/plugin-suggest'\nimport zh from './locales/zh.yml'\nimport en from './locales/en.yml'\nimport ja from './locales/ja.yml'\nimport fr from './locales/fr.yml'\nimport zhTW from './locales/zh-tw.yml'\n\ndeclare module 'koishi' {\n  interface Events {\n    'help/command'(output: string[], command: Command, session: Session): void\n    'help/option'(output: string, option: Argv.OptionVariant, command: Command, session: Session): string\n  }\n\n  namespace Command {\n    interface Config {\n      /** hide all options by default */\n      hideOptions?: boolean\n      /** hide command */\n      hidden?: boolean\n    }\n  }\n\n  namespace Argv {\n    interface OptionConfig {\n      hidden?: boolean | ((session: Session) => boolean)\n    }\n  }\n}\n\ninterface HelpOptions {\n  showHidden?: boolean\n  authority?: boolean\n}\n\nexport interface Config extends Command.Config {\n  shortcut?: boolean\n  options?: boolean\n}\n\nexport const Config: Schema<Config> = Schema.object({\n  shortcut: Schema.boolean().default(true).description('是否启用快捷调用。'),\n  options: Schema.boolean().default(true).description('是否为每个指令添加 `-h, --help` 选项。'),\n})\n\nexport function enableHelp<U extends User.Field, G extends Channel.Field, A extends any[], O extends {}>(cmd: Command<U, G, A, O>) {\n  return cmd.option('help', '-h', {\n    hidden: true,\n    // @ts-ignore\n    notUsage: true,\n    descPath: 'commands.help.options.help',\n  })\n}\n\nfunction executeHelp(session: Session, name: string) {\n  if (!session.app.$commander.getCommand('help')) return\n  return session.execute({\n    name: 'help',\n    args: [name],\n  })\n}\n\nexport const name = 'help'\n\nexport function apply(ctx: Context, config: Config = {}) {\n  ctx.i18n.define('zh', zh)\n  ctx.i18n.define('en', en)\n  ctx.i18n.define('ja', ja)\n  ctx.i18n.define('fr', fr)\n  ctx.i18n.define('zh-tw', zhTW)\n\n  if (config.options !== false) {\n    ctx.$commander._commandList.forEach(cmd => cmd.use(enableHelp))\n    ctx.on('command-added', cmd => cmd.use(enableHelp))\n  }\n\n  ctx.before('command/execute', (argv) => {\n    const { command, options, session } = argv\n    if (options['help'] && command._options.help) {\n      return executeHelp(session, command.name)\n    }\n\n    if (command['_actions'].length) return\n    return executeHelp(session, command.name)\n  })\n\n  const $ = ctx.$commander\n  function findCommand(target: string) {\n    const command = $.resolve(target)\n    if (command) return command\n    const shortcut = $._shortcuts.find(({ name }) => {\n      return typeof name === 'string' ? name === target : name.test(target)\n    })\n    if (shortcut) return shortcut.command\n  }\n\n  const createCollector = <T extends keyof Tables>(key: T): FieldCollector<T> => (argv, fields) => {\n    const { args: [target], session } = argv\n    const command = findCommand(target)\n    if (!command) return\n    session.collect(key, { ...argv, command, args: [], options: { help: true } }, fields)\n  }\n\n  const cmd = ctx.command('help [command:string]', { authority: 0, ...config })\n    .userFields(['authority'])\n    .userFields(createCollector('user'))\n    .channelFields(createCollector('channel'))\n    .option('authority', '-a')\n    .option('showHidden', '-H')\n    .action(async ({ session, options }, target) => {\n      if (!target) {\n        const commands = $._commandList.filter(cmd => cmd.parent === null)\n        const output = formatCommands('.global-prolog', session, commands, options)\n        const epilog = session.text('.global-epilog')\n        if (epilog) output.push(epilog)\n        return output.filter(Boolean).join('\\n')\n      }\n\n      const command = findCommand(target)\n      if (!command?.ctx.filter(session)) {\n        if (!ctx.$suggest) {\n          return session.text('.suggest-prefix')\n        }\n        return session.suggest({\n          target,\n          items: ctx.$suggest.getCommandNames(session),\n          prefix: session.text('.suggest-prefix'),\n          suffix: session.text('.suggest-suffix'),\n          async apply(suggestion) {\n            return showHelp($.getCommand(suggestion), this as any, options)\n          },\n        })\n      }\n\n      return showHelp(command, session, options)\n    })\n\n  if (config.shortcut !== false) cmd.shortcut('帮助', { fuzzy: true })\n}\n\nfunction* getCommands(session: Session<'authority'>, commands: Command[], showHidden = false): Generator<Command> {\n  for (const command of commands) {\n    if (!showHidden && command.config.hidden) continue\n    if (command.match(session)) {\n      yield command\n    } else {\n      yield* getCommands(session, command.children, showHidden)\n    }\n  }\n}\n\nfunction formatCommands(path: string, session: Session<'authority'>, children: Command[], options: HelpOptions) {\n  const commands = Array\n    .from(getCommands(session, children, options.showHidden))\n    .sort((a, b) => a.displayName > b.displayName ? 1 : -1)\n  if (!commands.length) return []\n\n  let hasSubcommand = false\n  const output = commands.map(({ name, displayName, config, children }) => {\n    let output = '    ' + displayName\n    if (options.authority) {\n      output += ` (${config.authority}${children.length ? (hasSubcommand = true, '*') : ''})`\n    }\n    output += '  ' + session.text([`commands.${name}.description`, ''])\n    return output\n  })\n  const hints: string[] = []\n  if (options.authority) hints.push(session.text('.hint-authority'))\n  if (hasSubcommand) hints.push(session.text('.hint-subcommand'))\n  const hintText = hints.length\n    ? session.text('general.paren', [hints.join(session.text('general.comma'))])\n    : ''\n  output.unshift(session.text(path, [hintText]))\n  return output\n}\n\nfunction getOptionVisibility(option: Argv.OptionConfig, session: Session<'authority'>) {\n  if (session.user && option.authority > session.user.authority) return false\n  return !session.resolveValue(option.hidden)\n}\n\nfunction getOptions(command: Command, session: Session<'authority'>, config: HelpOptions) {\n  if (command.config.hideOptions && !config.showHidden) return []\n  const options = config.showHidden\n    ? Object.values(command._options)\n    : Object.values(command._options).filter(option => getOptionVisibility(option, session))\n  if (!options.length) return []\n\n  const output: string[] = []\n  Object.values(command._options).forEach((option) => {\n    const authority = option.authority && config.authority ? `(${option.authority}) ` : ''\n    function pushOption(option: Argv.OptionVariant, name: string) {\n      if (!config.showHidden && !getOptionVisibility(option, session)) return\n      let line = `${authority}${segment.escape(option.syntax)}`\n      const description = session.text(option.descPath ?? [`commands.${command.name}.options.${name}`, ''])\n      if (description) line += '  ' + description\n      line = command.ctx.chain('help/option', line, option, command, session)\n      output.push('    ' + line)\n    }\n\n    if (!('value' in option)) pushOption(option, option.name)\n    for (const value in option.variants) {\n      pushOption(option.variants[value], `${option.name}.${value}`)\n    }\n  })\n\n  if (!output.length) return []\n  output.unshift(config.authority && options.some(o => o.authority)\n    ? session.text('.available-options-with-authority')\n    : session.text('.available-options'))\n  return output\n}\n\nasync function showHelp(command: Command, session: Session<'authority'>, config: HelpOptions) {\n  const output = [command.displayName + segment.escape(command.declaration)]\n\n  const description = session.text([`commands.${command.name}.description`, ''])\n  if (description) output.push(description)\n\n  if (session.app.database) {\n    const argv: Argv = { command, args: [], options: { help: true } }\n    const userFields = session.collect('user', argv)\n    await session.observeUser(userFields)\n    if (session.subtype === 'group') {\n      const channelFields = session.collect('channel', argv)\n      await session.observeChannel(channelFields)\n    }\n  }\n\n  if (command._aliases.length > 1) {\n    output.push(session.text('.command-aliases', [Array.from(command._aliases.slice(1)).join('，')]))\n  }\n\n  session.app.emit(session, 'help/command', output, command, session)\n\n  if (session.user && command.config.authority > 1) {\n    output.push(session.text('.command-authority', [command.config.authority]))\n  }\n\n  if (command._usage) {\n    output.push(typeof command._usage === 'string' ? command._usage : await command._usage(session))\n  } else {\n    const text = session.text([`commands.${command.name}.usage`, ''])\n    if (text) output.push(text)\n  }\n\n  output.push(...getOptions(command, session, config))\n\n  if (command._examples.length) {\n    output.push(session.text('.command-examples'), ...command._examples.map(example => '    ' + example))\n  } else {\n    const text = session.text([`commands.${command.name}.examples`, ''])\n    if (text) output.push(...text.split('\\n').map(line => '    ' + line))\n  }\n\n  output.push(...formatCommands('.subcommand-prolog', session, command.children, config))\n\n  return output.filter(Boolean).join('\\n')\n}\n"],
  "mappings": "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",
  "names": ["name", "cmd", "children", "output", "option"]
}
