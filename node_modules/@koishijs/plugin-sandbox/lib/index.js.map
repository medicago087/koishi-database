{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourcesContent": ["import { Bot, Context, defineProperty, Dict, Fragment, observe, Random, Schema, segment, User } from 'koishi'\nimport { DataService, SocketHandle } from '@koishijs/plugin-console'\nimport { resolve } from 'path'\nimport zh from './locales/zh.yml'\n\ndeclare module 'koishi' {\n  interface User {\n    sandbox: string\n  }\n\n  namespace Session {\n    interface Payload {\n      handle: SocketHandle\n    }\n  }\n}\n\ndeclare module '@koishijs/plugin-console' {\n  interface SocketHandle {\n    sandbox: SandboxBot\n  }\n\n  interface Events {\n    'sandbox/message'(this: SocketHandle, user: string, channel: string, content: string): void\n    'sandbox/user'(this: SocketHandle, name: string, data: Partial<User>): void\n  }\n\n  namespace Console {\n    interface Services {\n      users: UserProvider\n    }\n  }\n}\n\nclass SandboxBot extends Bot {\n  username = 'koishi'\n  hidden = true\n\n  constructor(public ctx: Context) {\n    super(ctx, {\n      platform: 'sandbox',\n      selfId: 'koishi',\n    })\n\n    const self = this\n    ctx.console.addListener('sandbox/message', async function (user, channel, content) {\n      ctx.console.broadcast('sandbox', { content, user, channel })\n      const session = self.session({\n        userId: user,\n        content,\n        channelId: channel,\n        guildId: channel === '@' + user ? undefined : channel,\n        type: 'message',\n        subtype: channel === '@' + user ? 'private' : 'group',\n        author: {\n          userId: user,\n          username: user,\n        },\n      })\n      defineProperty(session, 'handle', this)\n      self.dispatch(session)\n    }, { authority: 4 })\n  }\n\n  async sendMessage(channel: string, content: Fragment) {\n    const elements = segment.normalize(content)\n    const ids: string[] = []\n\n    let buffer = ''\n    const flush = () => {\n      if (!buffer.trim()) return\n      content = segment.transform(buffer.trim(), {\n        image(data) {\n          // for backward compatibility\n          if (!data.url.startsWith('base64://')) return segment('image', data)\n          return segment.image('data:image/png;base64,' + data.url.slice(9))\n        },\n      })\n      this.ctx.console.broadcast('sandbox', { content, user: 'Koishi', channel })\n      ids.push(Random.id())\n      buffer = ''\n    }\n\n    const render = (elements: segment[]) => {\n      for (const element of elements) {\n        const { type, children } = element\n        if (type === 'message') {\n          flush()\n          render(children)\n          flush()\n        } else {\n          buffer += element.toString()\n        }\n      }\n    }\n    render(elements)\n    flush()\n    return ids\n  }\n\n  async getGuildMemberList(guildId: string) {\n    return words.map((word) => ({\n      nickname: word,\n      userId: word,\n    }))\n  }\n}\n\nexport interface Message {\n  user: string\n  channel: string\n  content: string\n}\n\nexport const words = [\n  'Alice', 'Bob', 'Carol', 'Dave', 'Eve', 'Frank', 'Grace',\n  'Hank', 'Ivy', 'Jack', 'Kathy', 'Lily', 'Mandy', 'Nancy',\n  'Oscar', 'Peggy', 'Quinn', 'Randy', 'Sandy', 'Toby',\n  'Uma', 'Vicky', 'Wendy', 'Xander', 'Yvonne', 'Zoe',\n]\n\nexport class UserProvider extends DataService<Dict<User>> {\n  static using = ['database'] as const\n  private task: Promise<Dict<User.Observed>>\n\n  constructor(ctx: Context) {\n    super(ctx, 'users', { authority: 4 })\n\n    ctx.console.addListener('sandbox/user', async (name, data) => {\n      const users = await this.get()\n      if (!users[name]) {\n        if (!data) return\n        const user = await this.ctx.database.createUser('sandbox', name, {\n          authority: 1,\n          ...data,\n        })\n        return this.observe(user, users)\n      } else if (!data) {\n        delete users[name]\n        this.ctx.$internal._userCache.set('sandbox', 'sandbox:' + name, null)\n        return this.ctx.database.remove('user', { sandbox: name })\n      }\n      Object.assign(users[name], data)\n      return users[name].$update()\n    }, { authority: 4 })\n  }\n\n  observe(user: User, users: Dict<User.Observed>) {\n    const uid = 'sandbox:' + user.sandbox\n    users[user.sandbox] = observe(user, async (diff) => {\n      await this.ctx.database.setUser('sandbox', user.sandbox, diff)\n      this.refresh()\n    })\n    this.ctx.$internal._userCache.set('sandbox', uid, users[user.sandbox])\n  }\n\n  async prepare() {\n    const data = await this.ctx.database.getUser('sandbox', words)\n    const result: Dict<User.Observed> = {}\n    for (const user of data) {\n      this.observe(user, result)\n    }\n    return result\n  }\n\n  stop() {\n    // keep user cache active until disposed\n    this.ctx.$internal._userCache.delete('sandbox')\n  }\n\n  async get() {\n    return this.task ||= this.prepare()\n  }\n}\n\nexport const name = 'sandbox'\n\nexport const using = ['console']\n\nexport interface Config {}\n\nexport const Config: Schema<Config> = Schema.object({})\n\nexport function apply(ctx: Context, config: Config) {\n  ctx.plugin(SandboxBot)\n  ctx.plugin(UserProvider)\n\n  ctx.console.addEntry(process.env.KOISHI_BASE ? [\n    process.env.KOISHI_BASE + '/dist/index.js',\n    process.env.KOISHI_BASE + '/dist/style.css',\n  ] : process.env.KOISHI_ENV === 'browser' ? [\n    // @ts-ignore\n    import.meta.url.replace(/\\/src\\/[^/]+$/, '/client/index.ts'),\n  ] : {\n    dev: resolve(__dirname, '../client/index.ts'),\n    prod: resolve(__dirname, '../dist'),\n  })\n\n  ctx.i18n.define('zh', zh)\n\n  ctx.platform('sandbox').command('clear')\n    .action(({ session }) => {\n      session.handle.send({\n        type: 'sandbox/clear',\n      })\n    })\n}\n"],
  "mappings": "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",
  "names": ["elements", "name"]
}
