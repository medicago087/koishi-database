{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourcesContent": ["import { Argv, Context, deduplicate, difference, intersection, Schema } from 'koishi'\nimport { adminChannel } from '@koishijs/helpers'\n\ndeclare module 'koishi' {\n  namespace Command {\n    interface Config {\n      disabled?: boolean\n    }\n  }\n\n  interface Channel {\n    enable: string[]\n    disable: string[]\n  }\n}\n\nexport interface Config {}\n\nexport const name = 'switch'\nexport const using = ['database'] as const\nexport const Config: Schema<Config> = Schema.object({})\n\nexport function apply(ctx: Context, config: Config = {}) {\n  ctx.i18n.define('zh', require('./locales/zh'))\n\n  ctx.model.extend('channel', {\n    // enable: 'list',\n    disable: 'list',\n  })\n\n  ctx.before('attach-channel', (session, fields) => {\n    if (!session.argv) return\n    // fields.add('enable')\n    fields.add('disable')\n  })\n\n  // check channel\n  ctx.before('command/execute', ({ session, command }: Argv<never, 'enable' | 'disable'>) => {\n    const { enable = [], disable = [] } = session.channel || {}\n    while (command) {\n      if (command.config.disabled) {\n        if (enable.includes(command.name)) return null\n        return ''\n      } else {\n        if (disable.includes(command.name)) return ''\n        command = command.parent as any\n      }\n    }\n  })\n\n  ctx.command('switch <command...>', '启用和禁用功能', { authority: 3 })\n    .channelFields(['disable'])\n    .userFields(['authority'])\n    .use(adminChannel)\n    .action(async ({ session }, ...names: string[]) => {\n      const channel = session.channel\n      if (!names.length) {\n        if (!channel.disable.length) return session.text('.none')\n        return session.text('.list', [channel.disable.join(', ')])\n      }\n\n      names = deduplicate(names)\n      const forbidden = names.filter((name) => {\n        const command = ctx.$commander._commands.get(name)\n        return command && command.config.authority >= session.user.authority\n      })\n      if (forbidden.length) return session.text('.forbidden', [forbidden.join(', ')])\n\n      const add = difference(names, channel.disable)\n      const remove = intersection(names, channel.disable)\n      const preserve = difference(channel.disable, names)\n      const output: string[] = []\n      if (add.length) output.push(`禁用 ${add.join(', ')} 功能`)\n      if (remove.length) output.push(`启用 ${remove.join(', ')} 功能`)\n      channel.disable = [...preserve, ...add]\n      await channel.$update()\n      return `已${output.join('，')}。`\n    })\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBAA6E;AAC7E,qBAA6B;AAiBtB,IAAM,OAAO;AACb,IAAM,QAAQ,CAAC,UAAU;AACzB,IAAM,SAAyB,qBAAO,OAAO,CAAC,CAAC;AAE/C,SAAS,MAAM,KAAc,SAAiB,CAAC,GAAG;AACvD,MAAI,KAAK,OAAO,MAAM,YAAuB;AAE7C,MAAI,MAAM,OAAO,WAAW;AAAA,IAE1B,SAAS;AAAA,EACX,CAAC;AAED,MAAI,OAAO,kBAAkB,CAAC,SAAS,WAAW;AAChD,QAAI,CAAC,QAAQ;AAAM;AAEnB,WAAO,IAAI,SAAS;AAAA,EACtB,CAAC;AAGD,MAAI,OAAO,mBAAmB,CAAC,EAAE,SAAS,QAAQ,MAAyC;AACzF,UAAM,EAAE,SAAS,CAAC,GAAG,UAAU,CAAC,EAAE,IAAI,QAAQ,WAAW,CAAC;AAC1D,WAAO,SAAS;AACd,UAAI,QAAQ,OAAO,UAAU;AAC3B,YAAI,OAAO,SAAS,QAAQ,IAAI;AAAG,iBAAO;AAC1C,eAAO;AAAA,MACT,OAAO;AACL,YAAI,QAAQ,SAAS,QAAQ,IAAI;AAAG,iBAAO;AAC3C,kBAAU,QAAQ;AAAA,MACpB;AAAA,IACF;AAAA,EACF,CAAC;AAED,MAAI,QAAQ,uBAAuB,WAAW,EAAE,WAAW,EAAE,CAAC,EAC3D,cAAc,CAAC,SAAS,CAAC,EACzB,WAAW,CAAC,WAAW,CAAC,EACxB,IAAI,2BAAY,EAChB,OAAO,OAAO,EAAE,QAAQ,MAAM,UAAoB;AACjD,UAAM,UAAU,QAAQ;AACxB,QAAI,CAAC,MAAM,QAAQ;AACjB,UAAI,CAAC,QAAQ,QAAQ;AAAQ,eAAO,QAAQ,KAAK,OAAO;AACxD,aAAO,QAAQ,KAAK,SAAS,CAAC,QAAQ,QAAQ,KAAK,IAAI,CAAC,CAAC;AAAA,IAC3D;AAEA,gBAAQ,2BAAY,KAAK;AACzB,UAAM,YAAY,MAAM,OAAO,CAACA,UAAS;AACvC,YAAM,UAAU,IAAI,WAAW,UAAU,IAAIA,KAAI;AACjD,aAAO,WAAW,QAAQ,OAAO,aAAa,QAAQ,KAAK;AAAA,IAC7D,CAAC;AACD,QAAI,UAAU;AAAQ,aAAO,QAAQ,KAAK,cAAc,CAAC,UAAU,KAAK,IAAI,CAAC,CAAC;AAE9E,UAAM,UAAM,0BAAW,OAAO,QAAQ,OAAO;AAC7C,UAAM,aAAS,4BAAa,OAAO,QAAQ,OAAO;AAClD,UAAM,eAAW,0BAAW,QAAQ,SAAS,KAAK;AAClD,UAAM,SAAmB,CAAC;AAC1B,QAAI,IAAI;AAAQ,aAAO,KAAK,MAAM,IAAI,KAAK,IAAI,MAAM;AACrD,QAAI,OAAO;AAAQ,aAAO,KAAK,MAAM,OAAO,KAAK,IAAI,MAAM;AAC3D,YAAQ,UAAU,CAAC,GAAG,UAAU,GAAG,GAAG;AACtC,UAAM,QAAQ,QAAQ;AACtB,WAAO,IAAI,OAAO,KAAK,GAAG;AAAA,EAC5B,CAAC;AACL;AAxDgB;",
  "names": ["name"]
}
